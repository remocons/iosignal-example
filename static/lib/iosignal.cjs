"use strict";var e=require("buffer/index.js"),t=require("crypto"),s=require("stream"),r=require("net"),i=require("zlib"),n=require("fs"),o=require("path"),a=require("os"),h=require("buffer"),c=require("events"),l=require("https"),f=require("http"),u=require("tls"),d=require("url"),p=require("process");const _=new TextEncoder,g=new TextDecoder,m=y;function y(t,s=0){let r;if(void 0===t||"string"!=typeof t||"number"!=typeof s)throw TypeError("invlaid init variablie type name. ");return(t=t.toUpperCase()).includes("8")?(r=e.Buffer.alloc(1),t.includes("I")?r.writeInt8(s):r.writeUint8(s)):t.includes("16")?(r=e.Buffer.alloc(2),t.includes("I")?t.includes("L")?r.writeInt16LE(s):r.writeInt16BE(s):t.includes("L")?r.writeUint16LE(s):r.writeUint16BE(s)):t.includes("32")?(r=e.Buffer.alloc(4),t.includes("I")?t.includes("L")?r.writeInt32LE(s):r.writeInt32BE(s):t.includes("L")?r.writeUint32LE(s):r.writeUint32BE(s)):t.includes("F")?(r=e.Buffer.alloc(4),t.includes("L")?r.writeFloatLE(s):r.writeFloatBE(s)):t.includes("N")?r=e.Buffer.from(String(s)):console.log(`invalid type: ${t} or initvalue: ${s}`),r}const b=E;function E(t,s,r){let i,n="B";if("number"==typeof s)"number"==typeof r?(i=e.Buffer.alloc(s),0!==r&&i.fill(r),n="B"):(i=e.Buffer.from(String(s)),n="N");else if("string"==typeof s&&"number"==typeof r)n=s.toUpperCase(),i=y(s,r);else if("string"==typeof s&&void 0===r)i=e.Buffer.from(s),n="S";else if(s instanceof Uint8Array&&void 0===r)i=s instanceof e.Buffer?s:e.Buffer.from(s);else if(s instanceof ArrayBuffer&&void 0===r)i=e.Buffer.from(s);else if(ArrayBuffer.isView(s))i=e.Buffer.from(s.buffer,s.byteOffset,s.byteLength);else if("object"==typeof s&&void 0===r)i=e.Buffer.from(JSON.stringify(s)),n="O";else{if("boolean"!=typeof s||void 0!==r)throw TypeError("invalid meta buffer type");{const t=s?1:0;i=e.Buffer.from([t]),n="!"}}return"string"==typeof t&&t.includes("#")&&(t=""),[t,n,i]}const S=v;function v(...e){let t=0;return e.map((e=>{const s=t++;return"number"==typeof e?b(s,"N",e):b(s,e)}))}function k(e){if((e=e.toUpperCase()).includes("8"))return e.includes("I")?"int8":"uint8";if(e.includes("16"))return e.includes("I")?e.includes("L")?"int16_le":"int16_be":e.includes("L")?"uint16_le":"uint16_be";if(e.includes("32"))return e.includes("I")?e.includes("L")?"int32_le":"int32_be":e.includes("L")?"uint32_le":"uint32_be";if(e.includes("F"))return e.includes("L")?"float_le":"float_be";if("B"===e)return"buffer";if("S"===e)return"string";if("N"===e)return"number";if("O"===e)return"object";if("!"===e)return"boolean";throw TypeError("invalid data type")}function w(e,t,s,r){try{const i=k(e);if("int8"==i)return t.readInt8(s);if("uint8"===i)return t.readUint8(s);if("int16_le"===i)return t.readInt16LE(s);if("int16_be"===i)return t.readInt16BE(s);if("uint16_le"===i)return t.readUint16LE(s);if("uint16_be"===i)return t.readUint16BE(s);if("int32_le"===i)return t.readInt32LE(s);if("int32_be"===i)return t.readInt32BE(s);if("uint32_le"===i)return t.readUint32LE(s);if("uint32_be"===i)return t.readUint32BE(s);if("float_le"===i)return t.readFloatLE(s);if("float_be"===i)return t.readFloatBE(s);if("buffer"===i)return t.subarray(s,s+r);if("string"===i){const e=t.subarray(s,s+r);return g.decode(e)}if("number"===i){const e=t.subarray(s,s+r);return Number(g.decode(e))}if("object"===i){const e=t.subarray(s,s+r);return JSON.parse(g.decode(e))}if("boolean"===i){return 1===t.readInt8(s)}return}catch(e){}}function x(...t){const s=function(e){let t=[];return e.filter((e=>{if(!Array.isArray(e[0]))return e;t=t.concat(e)})).concat(t)}(t);let r=0;const i=[];let n,o,a=0;if(s.forEach((e=>{const[t,s,n]=e;r+=n.byteLength,("number"==typeof t||t.length>0)&&i.push([t,s,a,n.byteLength]),a=r})),i.length>0){let e=JSON.stringify(i);n=_.encode(e),o=n.byteLength,r=r+o+2}const h=e.Buffer.alloc(r);if(a=0,s.forEach((e=>{const t=e[2];h.set(t,a),a+=t.byteLength})),i.length>0){h.set(n,a);const e=m("16",o);return h.set(e,a+o),h}return h}function T(t,s){const r=s||W(t);if(!r)return;const i=e.Buffer.from(t),n={};let o=0;if(r.forEach((e=>{const[t,s,r,a]=e;let h=w(s,i,r,a);null!=h&&(n[t]=h,a&&(o+=a))})),s&&i.byteLength!==o){let e=i.byteLength-o,t=w("b",i,o,e);if(null==t)return;n.$OTHERS=t}let a=0,h=[];for(;n[a];)h.push(n[a++]);return h.length>0&&(n.args=h,n.$=n.args),n}const L=A;function A(e,t=!1){if(void 0===e)throw TypeError("Invalid data type: Undefined");if("string"==typeof e)return _.encode(e);if("number"==typeof e)return Uint8Array.from([e]);if(e instanceof ArrayBuffer){if(t)return new Uint8Array(e);{const t=new Uint8Array(e),s=new Uint8Array(e.byteLength);return s.set(t),s}}if(ArrayBuffer.isView(e)){if(t)return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);{const t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),s=new Uint8Array(e.byteLength);return s.set(t),s}}return _.encode(JSON.stringify(e))}const C=O;function O(t,s=!1){const r=A(t,s);return s?e.Buffer.from(r.buffer,r.byteOffset,r.byteLength):e.Buffer.from(r)}const N=I;function I(...t){const s=t.map((e=>O(e)));return e.Buffer.concat(s)}const B=R;function R(...e){try{let t=0,s=0;const r=e.map((e=>A(e)));r.forEach((e=>{t+=e.byteLength}));const i=new Uint8Array(t);return r.forEach((e=>{i.set(e,s),s+=e.byteLength})),i}catch(e){console.log(e)}}function M(e,t){if(e.byteLength!==t.byteLength)return!1;for(let s=0;s<e.byteLength;s++)if(e[s]!==t[s])return!1;return!0}function U(e){return 0===F(e)?e.byteLength:e.byteLength-F(e)-D}function P(e,t){try{const s=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),r=s.byteLength-t-2,i=s.subarray(r,s.byteLength-2),n=g.decode(i),o=JSON.parse(n);if(!Array.isArray(o)||!Array.isArray(o[0]))return;let a=o[0];if(!a)return;if(a.length<3)return;const[h,c,l]=a;if("string"!=typeof c||"number"!=typeof l)return;return o}catch(e){}}const D=2;function H(t){if(t instanceof ArrayBuffer&&(t=e.Buffer.from(t)),t instanceof Uint8Array){if(t.byteLength<=D)return 0;return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint16(t.byteLength-D)}return 0}function F(t){if(t instanceof ArrayBuffer&&(t=e.Buffer.from(t)),t instanceof Uint8Array){const e=t.byteLength;if(e<=D)return 0;const s=H(t);if(0===s||s>e)return 0;return P(t,s)?s:0}return 0}function $(e){const t=U(e);return e.subarray(0,t)}function W(t,s=!1){t instanceof ArrayBuffer&&(t=e.Buffer.from(t));const r=H(t);if(0===r)return;let i=P(t,r);return i?s?(i.forEach((e=>{null==e[3]&&(e[1].includes("8")?e[3]=1:e[1].includes("16")?e[3]=2:e[1].includes("32")||e[1].includes("F")?e[3]=4:e[1].includes("!")&&(e[3]=1)),e[4]=k(e[1])})),i):i:void 0}function z(...e){return $(x(...e))}function j(...e){return W(x(...e))}var G=Object.freeze({__proto__:null,B8:C,B8pack:N,Buffer:e.Buffer,MB:b,MBA:S,NB:m,TAIL_LEN:D,U8:L,U8pack:B,equal:M,getBuffer:$,getBufferSize:U,getMeta:W,getMetaDetail:function(e){return W(e,!0)},getMetaSize:F,hex:function(e){return Array.prototype.map.call(new Uint8Array(e),(e=>("00"+e.toString(16)).slice(-2))).join("")},meta:j,metaBuffer:E,metaBufferArguments:v,metaDetail:function(...e){return W(x(...e),!0)},numberBuffer:y,pack:x,parseBuffer:O,parseBufferThenConcat:I,parseMetaInfo:P,parseTypeName:k,parseUint8Array:A,parseUint8ThenConcat:R,rawPack:z,readTail:H,readTypedBuffer:w,unpack:T});function V(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var q={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,s="~";function r(){}function i(e,t,s){this.fn=e,this.context=t,this.once=s||!1}function n(e,t,r,n,o){if("function"!=typeof r)throw new TypeError("The listener must be a function");var a=new i(r,n||e,o),h=s?s+t:t;return e._events[h]?e._events[h].fn?e._events[h]=[e._events[h],a]:e._events[h].push(a):(e._events[h]=a,e._eventsCount++),e}function o(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function a(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(s=!1)),a.prototype.eventNames=function(){var e,r,i=[];if(0===this._eventsCount)return i;for(r in e=this._events)t.call(e,r)&&i.push(s?r.slice(1):r);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},a.prototype.listeners=function(e){var t=s?s+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var i=0,n=r.length,o=new Array(n);i<n;i++)o[i]=r[i].fn;return o},a.prototype.listenerCount=function(e){var t=s?s+e:e,r=this._events[t];return r?r.fn?1:r.length:0},a.prototype.emit=function(e,t,r,i,n,o){var a=s?s+e:e;if(!this._events[a])return!1;var h,c,l=this._events[a],f=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),f){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,r),!0;case 4:return l.fn.call(l.context,t,r,i),!0;case 5:return l.fn.call(l.context,t,r,i,n),!0;case 6:return l.fn.call(l.context,t,r,i,n,o),!0}for(c=1,h=new Array(f-1);c<f;c++)h[c-1]=arguments[c];l.fn.apply(l.context,h)}else{var u,d=l.length;for(c=0;c<d;c++)switch(l[c].once&&this.removeListener(e,l[c].fn,void 0,!0),f){case 1:l[c].fn.call(l[c].context);break;case 2:l[c].fn.call(l[c].context,t);break;case 3:l[c].fn.call(l[c].context,t,r);break;case 4:l[c].fn.call(l[c].context,t,r,i);break;default:if(!h)for(u=1,h=new Array(f-1);u<f;u++)h[u-1]=arguments[u];l[c].fn.apply(l[c].context,h)}}return!0},a.prototype.on=function(e,t,s){return n(this,e,t,s,!1)},a.prototype.once=function(e,t,s){return n(this,e,t,s,!0)},a.prototype.removeListener=function(e,t,r,i){var n=s?s+e:e;if(!this._events[n])return this;if(!t)return o(this,n),this;var a=this._events[n];if(a.fn)a.fn!==t||i&&!a.once||r&&a.context!==r||o(this,n);else{for(var h=0,c=[],l=a.length;h<l;h++)(a[h].fn!==t||i&&!a[h].once||r&&a[h].context!==r)&&c.push(a[h]);c.length?this._events[n]=1===c.length?c[0]:c:o(this,n)}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=s?s+e:e,this._events[t]&&o(this,t)):(this._events=new r,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=s,a.EventEmitter=a,e.exports=a}(q);var Y=V(q.exports);const Q=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]);function K(e,t,s,r,i){let n,o,a,h,c,l,f,u,d,p,_,g,m;for(;i>=64;){for(n=t[0],o=t[1],a=t[2],h=t[3],c=t[4],l=t[5],f=t[6],u=t[7],p=0;p<16;p++)_=r+4*p,e[p]=(255&s[_])<<24|(255&s[_+1])<<16|(255&s[_+2])<<8|255&s[_+3];for(p=16;p<64;p++)d=e[p-2],g=(d>>>17|d<<15)^(d>>>19|d<<13)^d>>>10,d=e[p-15],m=(d>>>7|d<<25)^(d>>>18|d<<14)^d>>>3,e[p]=(g+e[p-7]|0)+(m+e[p-16]|0);for(p=0;p<64;p++)g=(((c>>>6|c<<26)^(c>>>11|c<<21)^(c>>>25|c<<7))+(c&l^~c&f)|0)+(u+(Q[p]+e[p]|0)|0)|0,m=((n>>>2|n<<30)^(n>>>13|n<<19)^(n>>>22|n<<10))+(n&o^n&a^o&a)|0,u=f,f=l,l=c,c=h+g|0,h=a,a=o,o=n,n=g+m|0;t[0]+=n,t[1]+=o,t[2]+=a,t[3]+=h,t[4]+=c,t[5]+=l,t[6]+=f,t[7]+=u,r+=64,i-=64}return r}const J=function(){function e(){this.digestLength=32,this.blockSize=64,this.state=new Int32Array(8),this.temp=new Int32Array(64),this.buffer=new Uint8Array(128),this.bufferLength=0,this.bytesHashed=0,this.finished=!1,this.reset()}return e.prototype.reset=function(){return this.state[0]=1779033703,this.state[1]=3144134277,this.state[2]=1013904242,this.state[3]=2773480762,this.state[4]=1359893119,this.state[5]=2600822924,this.state[6]=528734635,this.state[7]=1541459225,this.bufferLength=0,this.bytesHashed=0,this.finished=!1,this},e.prototype.clean=function(){for(var e=0;e<this.buffer.length;e++)this.buffer[e]=0;for(e=0;e<this.temp.length;e++)this.temp[e]=0;this.reset()},e.prototype.update=function(e,t){if(void 0===t&&(t=e.length),this.finished)throw new Error("SHA256: can't update because hash was finished.");let s=0;if(this.bytesHashed+=t,this.bufferLength>0){for(;this.bufferLength<64&&t>0;)this.buffer[this.bufferLength++]=e[s++],t--;64===this.bufferLength&&(K(this.temp,this.state,this.buffer,0,64),this.bufferLength=0)}for(t>=64&&(s=K(this.temp,this.state,e,s,t),t%=64);t>0;)this.buffer[this.bufferLength++]=e[s++],t--;return this},e.prototype.finish=function(e){if(!this.finished){const e=this.bytesHashed,s=this.bufferLength,r=e/536870912|0,i=e<<3,n=e%64<56?64:128;this.buffer[s]=128;for(var t=s+1;t<n-8;t++)this.buffer[t]=0;this.buffer[n-8]=r>>>24&255,this.buffer[n-7]=r>>>16&255,this.buffer[n-6]=r>>>8&255,this.buffer[n-5]=r>>>0&255,this.buffer[n-4]=i>>>24&255,this.buffer[n-3]=i>>>16&255,this.buffer[n-2]=i>>>8&255,this.buffer[n-1]=i>>>0&255,K(this.temp,this.state,this.buffer,0,n),this.finished=!0}for(t=0;t<8;t++)e[4*t+0]=this.state[t]>>>24&255,e[4*t+1]=this.state[t]>>>16&255,e[4*t+2]=this.state[t]>>>8&255,e[4*t+3]=this.state[t]>>>0&255;return this},e.prototype.digest=function(){const e=new Uint8Array(this.digestLength);return this.finish(e),e},e.prototype._saveState=function(e){for(let t=0;t<this.state.length;t++)e[t]=this.state[t]},e.prototype._restoreState=function(e,t){for(let t=0;t<this.state.length;t++)this.state[t]=e[t];this.bytesHashed=t,this.finished=!1,this.bufferLength=0},e}(),X=function(){function e(e){this.inner=new J,this.outer=new J,this.blockSize=this.inner.blockSize,this.digestLength=this.inner.digestLength;const t=new Uint8Array(this.blockSize);if(e.length>this.blockSize)(new J).update(e).finish(t).clean();else for(var s=0;s<e.length;s++)t[s]=e[s];for(s=0;s<t.length;s++)t[s]^=54;this.inner.update(t);for(s=0;s<t.length;s++)t[s]^=106;this.outer.update(t),this.istate=new Uint32Array(8),this.ostate=new Uint32Array(8),this.inner._saveState(this.istate),this.outer._saveState(this.ostate);for(s=0;s<t.length;s++)t[s]=0}return e.prototype.reset=function(){return this.inner._restoreState(this.istate,this.inner.blockSize),this.outer._restoreState(this.ostate,this.outer.blockSize),this},e.prototype.clean=function(){for(let e=0;e<this.istate.length;e++)this.ostate[e]=this.istate[e]=0;this.inner.clean(),this.outer.clean()},e.prototype.update=function(e){return this.inner.update(e),this},e.prototype.finish=function(e){return this.outer.finished?this.outer.finish(e):(this.inner.finish(e),this.outer.update(e,this.digestLength).finish(e)),this},e.prototype.digest=function(){const e=new Uint8Array(this.digestLength);return this.finish(e),e},e}();function Z(e){const t=(new J).update(e),s=t.digest();return t.clean(),s}const ee={hash:function(e){return Z(L(e))},hex:function(e){return C(Z(L(e))).toString("hex")},base64:function(e){return C(Z(L(e))).toString("base64")}};ee.hmac=function(e,t){return function(e,t){const s=new X(e).update(t),r=s.digest();return s.clean(),r}(L(e),L(t))};const te=b;let se={AUTH_REQ:176,AUTH_NONCE:177,AUTH_HMAC:178,AUTH_ACK:179,AUTH_FAIL:180,AUTH_EXT:181,ENC_PACK:182,ENC_E2E:183,ENC_488:184};for(let e in se)se[se[e]]=e;const re={AUTH_REQ:j(te("header","8",0),te("reserved","8",0)),AUTH_NONCE:j(te("header","8",0),te("unixTime","32L",0),te("milTime","32L",0),te("nonce",e.Buffer.alloc(4))),AUTH_HMAC:j(te("header","8",0),te("id8",e.Buffer.alloc(8)),te("nonce",e.Buffer.alloc(4)),te("hmac32",e.Buffer.alloc(32))),AUTH_ACK:j(te("header","8",0),te("hmac32",e.Buffer.alloc(32))),ENC_PACK:j(te("type","8",0),te("len","32L",0),te("salt12",e.Buffer.alloc(12)),te("hmac",8,0)),ENC_488:j(te("type","8",0),te("len","32L",0),te("otpSrc8",e.Buffer.alloc(8)),te("hmac8",e.Buffer.alloc(8)))};function ie(e){let t=e[e.length-1];return t[2]+t[3]}const ne={AUTH_REQ:ie(re.AUTH_REQ),AUTH_NONCE:ie(re.AUTH_NONCE),AUTH_HMAC:ie(re.AUTH_HMAC),AUTH_ACK:ie(re.AUTH_ACK),ENC_PACK:ie(re.ENC_PACK),ENC_488:ie(re.ENC_488)};let oe=!1;try{oe="[object process]"===Object.prototype.toString.call(global.process)}catch(e){}function ae(s){return oe?t.webcrypto.getRandomValues(e.Buffer.alloc(s)):self.crypto.getRandomValues(e.Buffer.alloc(s))}class he{constructor(){this._id8=e.Buffer.alloc(8),this._otpSrc44=e.Buffer.alloc(44),this._otp36=e.Buffer.alloc(36),this._hmac=e.Buffer.alloc(32),this.auth_salt12=e.Buffer.alloc(12),this.localNonce=e.Buffer.alloc(4),this.remoteNonce=e.Buffer.alloc(4),this.isAuthorized=!1}clearAuth(){this._id8.fill(0),this._otpSrc44.fill(0),this._otp36.fill(0),this._hmac.fill(0),this.auth_salt12.fill(0),this.localNonce.fill(0),this.remoteNonce.fill(0),this.isAuthorized=!1}set_hash_id8(e){C(ee.hash(e)).copy(this._id8,0,0,8)}set_id8(e){let t=C(e);this._id8.fill(0),t.copy(this._id8,0,0,8)}set_key(e){C(ee.hash(e)).copy(this._otpSrc44,0,0,32)}set_id_key(e){let t=e.indexOf(".");if(-1==t)return;let s=e.substring(0,t),r=e.substring(t+1);this.set_id8(s),this.set_key(r)}copy_id8(e){e.copy(this._id8,0,0,8)}copy_key(e){e.copy(this._otpSrc44,0,0,32)}sha256_n(e,t){let s=ee.hash(e);for(let e=0;e<t;e++)s=ee.hash(s);return s}set_clock_rand(){let t=Date.now(),s=parseInt(t/1e3);t%=4294967295;e.Buffer.concat([m("32L",s),m("32L",t),ae(4)]).copy(this._otpSrc44,32)}set_clock_nonce(t){let s=Date.now(),r=parseInt(s/1e3);s%=4294967295;e.Buffer.concat([m("32L",r),m("32L",s),t]).copy(this._otpSrc44,32)}set_salt12(e){e.copy(this._otpSrc44,32)}resetOTP(){C(ee.hash(this._otpSrc44)).copy(this._otp36,0,0,32)}getIndexOTP(e){return this._otp36.writeUInt32LE(e,32),ee.hash(this._otp36)}generateHMAC(t){let s=e.Buffer.concat([this._otpSrc44,t]);this._hmac=C(ee.hash(s))}getHMAC8(t){let s=e.Buffer.concat([this._otpSrc44,t]);return this._hmac=C(ee.hash(s)),this._hmac.subarray(0,8)}xotp(e,t=0,s=!1){let r=(e=C(e,s)).byteLength,i=t,n=0,o=0;for(;r>0;){o=r<32?r:32;let t=this.getIndexOTP(++i);for(let s=0;s<o;s++)e[n++]^=t[s];r-=32}return e}auth_req(){return x(b("#type","8",se.AUTH_REQ),b("#reserved","8",0))}auth_nonce(){let t=Date.now(),s=Math.floor(t/1e3),r=t%1e3;return this.localNonce=ae(4),this.auth_salt12=e.Buffer.concat([m("32L",s),m("32L",r),this.localNonce]),e.Buffer.concat([m("8",se.AUTH_NONCE),this.auth_salt12])}auth_hmac(t){let s=T(t,re.AUTH_NONCE);if(s){let t=e.Buffer.concat([m("32L",s.unixTime),m("32L",s.milTime),s.nonce]);return this.set_salt12(t),this.localNonce=ae(4),this.generateHMAC(this.localNonce),this.remoteNonce=s.nonce,x(b("#header","8",se.AUTH_HMAC),b("#id8",this._id8),b("#nonce",this.localNonce),b("#hmac32",this._hmac))}return!1}check_auth_hmac(t){let s;if(t instanceof Uint8Array){if(s=T(t,re.AUTH_HMAC),!s)return}else s=t;this.set_salt12(this.auth_salt12),this.generateHMAC(s.nonce);let r=this._hmac;if(M(s.hmac32,r)){this.remoteNonce=s.nonce;let t=e.Buffer.concat([this.localNonce,this.remoteNonce,this.localNonce]);this.set_salt12(t),this.generateHMAC(s.nonce);let r=this._hmac,i=z(b("header","8",se.AUTH_ACK),b("hmac32",r));return this.isAuthorized=!0,i}return!1}check_auth_ack_hmac(t){let s=T(t,re.AUTH_ACK);if(s){let t=e.Buffer.concat([this.remoteNonce,this.localNonce,this.remoteNonce]);if(this.set_salt12(t),this.generateHMAC(this.localNonce),M(this._hmac,s.hmac32))return this.isAuthorized=!0,!0}}encrypt_488(e){if(!this.isAuthorized)return;e=C(e),this.set_clock_nonce(this.remoteNonce),this.resetOTP();let t=this.getHMAC8(e),s=this.xotp(e);return x(b("#type","8",se.ENC_488),b("#len","32L",e.byteLength),b("#otpSrc8",this._otpSrc44.subarray(32,40)),b("#hmac8",t),b("#xdata",s))}decrypt_488(t){let s=T(t=C(t),re.ENC_488);if(s){let t=e.Buffer.concat([s.otpSrc8,this.localNonce]);this.set_salt12(t),this.resetOTP();let r=s.$OTHERS.subarray(0,s.len),i=this.xotp(r);if(M(this.getHMAC8(i),s.hmac8))return i}}encryptPack(e){e=C(e),this.set_clock_rand(),this.resetOTP();let t=this.getHMAC8(e),s=this.xotp(e);return x(b("#type","8",se.ENC_PACK),b("#len","32L",e.byteLength),b("#salt12",this._otpSrc44.subarray(32)),b("#hmac8",t),b("#xdata",s))}decryptPack(e){if(e[0]!==se.ENC_PACK)return;if(e.readUint32LE(1)==e.byteLength-ne.ENC_PACK)try{let t=T(e,re.ENC_PACK);if(!t)return;this.set_salt12(t.salt12),this.resetOTP();let s=t.$OTHERS,r=this.xotp(s),i=this.getHMAC8(r);if(M(t.hmac,i))return t.data=r,t}catch(e){}}encrypt_e2e(t,s){let r=e.Buffer.alloc(32);r.set(this._otpSrc44.subarray(0,32)),this.set_key(s);let i=this.encryptPack(t);return this._otpSrc44.set(r),i}decrypt_e2e(t,s){let r=e.Buffer.alloc(32);r.set(this._otpSrc44.subarray(0,32)),this.set_key(s);let i=this.decryptPack(t);return this._otpSrc44.set(r),i}}const ce={OPENING:0,OPEN:1,CLOSING:2,CLOSED:3,SERVER_READY:4,AUTH_FAIL:5,AUTH_READY:6,READY:7,REDIRECTING:8};for(let e in ce)ce[ce[e]]=e;const le={INIT:0,SENT_SERVER_READY:1,RECV_AUTH_REQ:2,SENT_SERVER_NONCE:3,RECV_AUTH_HMAC:4,AUTH_FAIL:5,AUTH_READY:6,CID_READY:7};for(let e in le)le[le[e]]=e;let fe={NO:0,YES:1,AUTO:2};for(let e in fe)fe[fe[e]]=e;const ue={TAG_LEN1:255,TAG_LEN2:65535,CONNECTION_CHECKER_PERIOD:3e3,PROMISE_TIMEOUT:5e3,DID:8,CID:12};let de={EMPTY:0,TEXT:1,BINARY:2,OBJECT:3,MJSON:4,MBA:5};for(let e in de)de[de[e]]=e;let pe={SERVER_READY:192,CID_REQ:193,CID_RES:194,QUOTA_LEVEL:195,SERVER_CLEAR_AUTH:196,SERVER_REDIRECT:197,LOOP:203,ECHO:204,PING:205,PONG:206,CLOSE:207,SIGNAL:208,SIGNAL_REQ:209,SIGNAL_E2E:210,SUBSCRIBE:211,SUBSCRIBE_REQ:212,UNSUBSCRIBE:213,SERVER_SIGNAL:214,IAM:217,IAM_RES:218,SET:219,RESPONSE_CODE:220,RESPONSE_MBP:221,REQUEST:222,RESPONSE:223,FLOW_MODE:240,WAIT:241,RESUME:242,TIME_OUT:253,OVER_SIZE:254,OVER_FLOW:255};for(let e in pe)pe[pe[e]]=e;let _e={0:{signalSize:1500,publishCounter:10,trafficRate:1e4},1:{signalSize:255,publishCounter:10,trafficRate:1e5},2:{signalSize:65535,publishCounter:10,trafficRate:1048576},3:{signalSize:1048576,publishCounter:10,trafficRate:20971520},10:{signalSize:1500,publishCounter:5,trafficRate:20971520},11:{signalSize:65535,publishCounter:10,trafficRate:20971520},12:{signalSize:1048576,publishCounter:100,trafficRate:20971520},200:{signalSize:20971520,publishCounter:1e4,trafficRate:104857600},255:{signalSize:20971520,publishCounter:1e4,trafficRate:104857600}};const ge=new TextEncoder;function me(e,...t){if("string"!=typeof e)throw TypeError("tag should be string.");let s,r=ge.encode(e),i=function(e){let t,s;if(0==e.length)t=de.EMPTY,s=null;else if(1==e.length)if("string"==typeof e[0]||"number"==typeof e[0])t=de.TEXT,s=ge.encode(e[0]+"."),s[s.byteLength-1]=0;else if(ArrayBuffer.isView(e[0])||e[0]instanceof ArrayBuffer)t=de.BINARY,s=C(e[0]);else{if("object"!=typeof e[0])throw new Error("unknown payload arguments");t=de.OBJECT,s=ge.encode(JSON.stringify(e[0]))}else{let r=!1;e.forEach((e=>{(ArrayBuffer.isView(e)||e instanceof ArrayBuffer)&&(r=!0)})),r?t=de.MBA:(t=de.MJSON,s=ge.encode(JSON.stringify(e)))}return{type:t,buffer:s}}(t);if(i.type==de.EMPTY)s=x(b("#MsgType","8",pe.SIGNAL),b("#tagLen","8",r.byteLength),b("#tag",r),b("#payloadType","8",i.type));else if(i.type==de.MBA){let e=x(S(...t));s=x(b("#MsgType","8",pe.SIGNAL),b("#tagLen","8",r.byteLength),b("#tag",r),b("#payloadType","8",i.type),b("#mbaBuffer",e))}else s=x(b("#MsgType","8",pe.SIGNAL),b("#tagLen","8",r.byteLength),b("#tag",r),b("#payloadType","8",i.type),b("#payload",i.buffer));return s}const ye=new TextEncoder,be=new TextDecoder;class Ee extends Y{constructor(e){super(),this.cid="",this.ip="",this.socket=null,this.url=e,this.state=ce.CLOSED,this.stateName=this.getStateName(),this.txCounter=0,this.rxCounter=0,this.txBytes=0,this.rxBytes=0,this.lastTxRxTime=Date.now(),this.connectionCheckerPeriod=ue.CONNECTION_CHECKER_PERIOD,this.connectionCheckerIntervalID=null,this.boho=new he,this.TLS=!1,this.encMode=fe.AUTO,this.useAuth=!1,this.nick="",this.channels=new Set,this.promiseMap=new Map,this.promiseTimeOut=ue.PROMISE_TIMEOUT,this.mid=0,this.level=3,this.quota=_e[this.level],this.serverSet={},this.linkMap=new Map,this.on("open",this.onOpen.bind(this)),this.on("close",this.onClose.bind(this)),this.on("socket_data",this.onData.bind(this))}redirect(e){this.close(),this.stateChange("redirecting"),this.createConnection(e)}open(e){if(e||this.url){if(e)if(this.url){if(e!==this.url&&(this.url=e,this.socket))return void this.close()}else this.url=e;this.createConnection(this.url),this.connectionCheckerIntervalID||(this.connectionCheckerIntervalID=setInterval(this.keepAlive.bind(this),this.connectionCheckerPeriod))}}onOpen(){this.url.includes("wss://")?this.TLS=!0:this.TLS=!1,this.stateChange("open")}onClose(){this.boho.isAuthorized=!1,this.cid="",this.stateChange("closed")}login(e,t){if(!e&&!t)return void console.log("no id and key.");if(console.log("manual login: ",e),!t&&e.includes("."))this.boho.set_id_key(e);else{if(!e||!t)return void console.log("no id or key.");this.boho.set_id8(e),this.boho.set_key(t)}this.useAuth=!0;let s=this.boho.auth_req();this.send(s)}auth(e,t){if(e||t){if(!t&&e.includes("."))this.boho.set_id_key(e);else{if(!e||!t)return void console.log("no id or key.");this.boho.set_id8(e),this.boho.set_key(t)}this.useAuth=!0}else console.log("no id and key.")}onData(t){let s,r=t[0];if(r===se.ENC_488)s=this.boho.decrypt_488(t),s&&(r=s[0],t=s);else if(r===se.ENC_E2E)try{if(s=this.boho.decrypt_488(t),!s)return;r=s[0],t.set(s,ne.ENC_488),t=t.subarray(ne.ENC_488)}catch(e){return}let i=pe[r];switch(i||(i=se[r]),r){case pe.OVER_SIZE:console.log("## server sent: over_size event."),this.emit("over_size","over_size");break;case pe.PING:this.pong();break;case pe.PONG:break;case pe.IAM_RES:try{let e=be.decode(t.subarray(1)),s=JSON.parse(e);s.ip&&(this.ip=s.ip),console.log("<IAM_RES>",JSON.stringify(s))}catch(e){}break;case pe.CID_RES:let r=be.decode(t.subarray(1));this.cid=r,this.stateChange("ready","cid_ready"),this.subscribe_memory_channels();break;case pe.QUOTA_LEVEL:let i=t[1];this.level=i,this.quota=_e[i],console.log("## QUOTA:",i,JSON.stringify(this.quota));break;case pe.SERVER_CLEAR_AUTH:this.useAuth=!1,this.boho.clearAuth(),this.stop();break;case pe.SERVER_REDIRECT:let n,o,a;7==t.byteLength?(n=function(e){if(6!=e.byteLength)return;return e[0].toString()+"."+e[1].toString()+"."+e[2].toString()+"."+e[3].toString()+":"+((e[4]<<8)+e[5]).toString()}(t.subarray(1)),a="cong://"):(n=be.decode(t.subarray(1)),a=""),o=a+n,this.redirect(o);break;case pe.SERVER_READY:this.stateChange("server_ready","server_ready"),this.useAuth?this.send(this.boho.auth_req()):this.send(e.Buffer.from([pe.CID_REQ]));break;case pe.SERVER_SIGNAL:try{let e=be.decode(t.subarray(1)),s=JSON.parse(e);s.event&&s.data&&(this.serverSet=s.data,this.emit(s.event,s.data))}catch(e){}break;case pe.SET:try{let e=T(t);e&&this.emit(e.topic,...e.args)}catch(e){}break;case pe.SIGNAL_E2E:case pe.SIGNAL:try{let e=t.readUint8(1),s=t.subarray(2,2+e),r=be.decode(s),i=t.readUint8(2+e),n=t.subarray(3+e);switch(i){case de.EMPTY:0===r.indexOf("@")?this.emit("@",null,r):this.emit(r,null,r);break;case de.TEXT:let e=n.subarray(0,n.byteLength-1),t=be.decode(e);0===r.indexOf("@")&&this.emit("@",t,r),"@"!==r&&this.emit(r,t,r);break;case de.BINARY:0===r.indexOf("@")&&this.emit("@",n,r),"@"!==r&&this.emit(r,n,r);break;case de.OBJECT:let s=be.decode(n),i=JSON.parse(s);0===r.indexOf("@")&&this.emit("@",i,r),"@"!==r&&this.emit(r,i,r);break;case de.MJSON:let o=be.decode(n),a=JSON.parse(o);0===r.indexOf("@")&&this.emit("@",...a,r),"@"!==r&&this.emit(r,...a,r);break;case de.MBA:let h=T(n);0===r.indexOf("@")&&this.emit("@",...h.args,r),"@"!==r&&this.emit(r,...h.args,r)}}catch(e){}break;case pe.RESPONSE_MBP:this.testPromise(t);break;case se.AUTH_NONCE:let h=this.boho.auth_hmac(t);h?this.send(h):this.stateChange("auth_fail","Invalid local auth_hmac.");break;case se.AUTH_FAIL:this.stateChange("auth_fail","server reject auth.");break;case se.AUTH_ACK:this.boho.check_auth_ack_hmac(t)?(this.stateChange("auth_ready","server sent auth_ack"),this.send(e.Buffer.from([pe.CID_REQ]))):this.stateChange("auth_fail","invalid server_hmac");break;default:try{s=be.decode(t),this.emit("text_message",s)}catch(e){}}}iam(e){e?this.send_enc_mode(x(b("#MsgType","8",pe.IAM),b("#",e))):this.send_enc_mode(x(b("#MsgType","8",pe.IAM)))}ping(){this.send(e.Buffer.from([pe.PING]))}pong(){this.send(e.Buffer.from([pe.PONG]))}echo(t){t?(console.log("echo args:",t),this.send_enc_mode(x(b("#MsgType","8",pe.ECHO),b("#msg",t)))):this.send(e.Buffer.from([pe.ECHO]))}bin(...e){this.send(B(...e))}send(e){if(e.byteLength>this.quota.signalSize)return this.emit("over_size"),console.log("## QUOTA LIMIT OVER!! \nsignal message.byteLength: ",e.byteLength),void console.log("## your maximum signalSize(bytes) is:",this.quota.signalSize);this.socket_send(e)}getEncryptionMode(){return!(this.encMode!==fe.YES&&(this.encMode!==fe.AUTO||this.TLS||!this.boho.isAuthorized))}send_enc_mode(t,s){if(void 0===s&&(s=this.getEncryptionMode()),t[0]==pe.SIGNAL_E2E&&s){let s=t[1],r=this.boho.encrypt_488(t.subarray(0,3+s));r[0]=se.ENC_E2E,this.send(e.Buffer.concat([r,t.subarray(3+s)]))}else if(s){let e=this.boho.encrypt_488(t);this.send(e)}else this.send(t)}setMsgPromise(e){return new Promise(((t,s)=>{this.promiseMap.set(e,[t,s]),setTimeout((t=>{this.promiseMap.has(e)&&(s("timeout"),this.promiseMap.delete(e))}),this.promiseTimeOut)}))}testPromise(e){let t=T(e);if(t)if(this.promiseMap.has(t.mid)){let[e,s]=this.promiseMap.get(t.mid);this.promiseMap.delete(t.mid),t.status<128?(t.ok=!0,e(t)):(t.ok=!1,s(t))}else console.log("no promise id")}publish(...e){this.signal(...e)}signal(e,...t){if("string"!=typeof e)throw TypeError("tag should be string.");let s=me(e,...t);this.send_enc_mode(s)}decrypt_e2e(e,t){return this.boho.decrypt_e2e(e,t)}signal_e2e(e,t,s){if("string"!=typeof e)throw TypeError("tag should be string.");let r=ye.encode(e),i=C(t),n=this.boho.encrypt_e2e(i,s),o=x(b("#MsgType","8",pe.SIGNAL_E2E),b("#tagLen","8",r.byteLength),b("#tag",r),b("#payloadType","8",de.BINARY),b("#payload",n));this.send_enc_mode(o)}set(e,...t){return e&&0!=t.length?this.req("store","set",e,...t):Promise.reject(new Error("set need storeName and value)"))}async get(e){if(!e)return Promise.reject(new Error("store get need storeName)"));let t=await this.req("store","get",e),{$:s}=T(t.body);return s}req(e,t,...s){if(!e||!t)return Promise.reject(new Error("request need target and topic)"));let r;return r=s.length>0?x(b("#MsgType","8",pe.REQUEST),b("mid","16",++this.mid),b("target",e),b("topic",t),S(...s)):x(b("#MsgType","8",pe.REQUEST),b("mid","16",++this.mid),b("target",e),b("topic",t)),this.send_enc_mode(r),this.setMsgPromise(this.mid)}subscribe(t){if("string"!=typeof t)throw TypeError("tag should be string.");if(this.state!==ce.READY)return;t.split(",").forEach((e=>{this.channels.add(e)}));let s=ye.encode(t);if(s.byteLength>ue.TAG_LEN1)throw TypeError("please use tag string bytelength below:"+ue.TAG_LEN1);this.send_enc_mode(e.Buffer.concat([m("8",pe.SUBSCRIBE),m("8",s.byteLength),s]))}subscribe_promise(t){if("string"!=typeof t)throw TypeError("tag should be string.");if(this.state!==ce.READY)return Promise.reject("subscribe_promise:: connection is not ready");let s=ye.encode(t);if(s.byteLength>ue.TAG_LEN2)throw TypeError("please use tag string bytelength: "+ue.TAG_LEN2);return this.send_enc_mode(e.Buffer.concat([m("8",pe.SUBSCRIBE_REQ),m("16",++this.mid),m("16",s.byteLength),s])),this.setMsgPromise(this.mid)}subscribe_memory_channels(){if(0==this.channels.size)return;let e=Array.from(this.channels).join(",");this.subscribe_promise(e).then((e=>{})).catch((e=>{console.log(">> SUBSCRIBE FAIL:",e)}))}unsubscribe(t=""){if("string"!=typeof t)throw TypeError("tag should be string.");if(""==t)this.channels.clear();else{t.split(",").forEach((e=>{this.channels.delete(e)}))}let s=ye.encode(t);if(s.byteLength>ue.TAG_LEN1)throw TypeError("please use tag string bytelength below:"+ue.TAG_LEN1);this.send_enc_mode(e.Buffer.concat([m("8",pe.UNSUBSCRIBE),m("8",s.byteLength),s]))}listen(e,t){if("string"!=typeof e)throw TypeError("tag should be string.");if(e.length>255||0==e.length)throw TypeError("tag string length range: 1~255");if("function"!=typeof t)throw TypeError("handler is not a function.");0!==e.indexOf("@")&&this.channels.add(e),this.on(e,t)}link(e,t,s){if("string"!=typeof e)throw TypeError("to(local link target) is not a string.");if("string"!=typeof t)throw TypeError("tag is not a string.");if(t.length>255||0==t.length)throw TypeError("tag string length range: 1~255");if("function"!=typeof s)throw TypeError("handler is not a function.");let r;0!==t.indexOf("@")&&this.channels.add(t),r=this.linkMap.has(e)?this.linkMap.get(e):new Set,r.add(t),this.linkMap.set(e,r),this.on(t,s),this.subscribe(t)}unlink(e,t){if("string"!=typeof e)throw TypeError("to(local link target) is not a string.");if("string"!=typeof t)throw TypeError("tag is not a string.");if(t.length>255||0==t.length)throw TypeError("tag string length range: 1~255");if(!this.linkMap.has(e))return;let s=this.linkMap.get(e),r=Array.from(s);for(let i=0;i<r.length;i++)if(r[i]==t){this.unsubscribe(t),this.removeAllListeners(t),s.delete(t),this.linkMap.set(e,s);break}}unlinkAll(e){if("string"!=typeof e)throw TypeError("to(local link target) is not a string.");if(!this.linkMap.has(e))return;let t=this.linkMap.get(e),s=Array.from(t);for(let e=0;e<s.length;e++)this.unsubscribe(s[e]),this.removeAllListeners(s[e]),t.delete(s[e]);this.linkMap.delete(e)}getMetric(){return{tx:this.txCounter,rx:this.rxCounter,txb:this.txBytes,rxb:this.rxBytes,last:(Date.now()-this.lastTxRxTime)/1e3}}getState(){return this.state}getStateName(){return ce[this.state].toLowerCase()}getSecurity(){return{useAuth:this.useAuth,isTLS:this.TLS,isAuthorized:this.boho.isAuthorized,encMode:this.encMode,usingEncryption:this.getEncryptionMode()}}stateChange(e,t){let s=e.toLowerCase();this.state=ce[e.toUpperCase()],t&&this.emit(s,t),this.stateName!==s&&(this.stateName=s,this.emit("change",s))}}const Se=1,ve=2,ke=3,we=4;function xe(e){if(e.byteLength<256)return x(b("#type","8",Se),b("#payloadLen1","8",e.byteLength),b("#payload",e));if(e.byteLength<65536)return x(b("#type","8",ve),b("#payloadLen2","16L",e.byteLength),b("#payload",e));if(e.byteLength<2**24){let t=Buffer.alloc(4);t.writeUint32LE(e.byteLength);let s=t.subarray(0,3);return x(b("#type","8",ke),b("#payloadLen3",s),b("#payload",e))}return x(b("#type","8",we),b("#payloadLen4","32L",e.byteLength),b("#payload",e))}class Te extends s.Transform{constructor(e){super(e),this.buffer=Buffer.alloc(0),this.frames=[],this.rxi=0,this.rxi_zero=0}_transform(e,t,s){this.addData(e),this.frames.length>0&&(this.frames.forEach((e=>{this.push(e)})),this.frames=[]),s()}addData(e){let t=e.byteLength,s=0;for(;t--;)this.rxi++,0==e[s++]&&this.rxi_zero++;this.buffer.byteLength>0?this.buffer=Buffer.concat([this.buffer,e]):this.buffer=e,this.parse()}parse(){let e,t,s=this.buffer[0];if(s==Se){if(e=2,this.buffer.byteLength<e)return;t=this.buffer.readUint8(1)}else if(s==ve){if(e=3,this.buffer.byteLength<e)return;t=this.buffer.readUint16LE(1)}else if(s==ke){if(e=4,this.buffer.byteLength<e)return;t=this.buffer.readUint16LE(1)+65536*this.buffer.readUint8(3)}else if(s==we){if(e=5,this.buffer.byteLength<e)return;t=this.buffer.readUint32LE(1)}else this.emit("wrong",this.buffer),this.buffer=Buffer.alloc(0);if(t==this.buffer.byteLength-e)return this.frames.push(this.buffer.subarray(e)),void(this.buffer=Buffer.alloc(0));t<this.buffer.byteLength-e&&(this.frames.push(this.buffer.subarray(e,e+t)),this.buffer=this.buffer.subarray(e+t),this.parse())}}var Le={exports:{}};const Ae=["nodebuffer","arraybuffer","fragments"],Ce="undefined"!=typeof Blob;Ce&&Ae.push("blob");var Oe={BINARY_TYPES:Ae,EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",hasBlob:Ce,kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}},Ne={exports:{}};function Ie(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Be,Re,Me,Ue,Pe,De,He={exports:{}};function Fe(){if(Me)return He.exports;Me=1;const e="function"==typeof __webpack_require__?__non_webpack_require__:Ie;return"function"==typeof e.addon?He.exports=e.addon.bind(e):He.exports=function(){if(Re)return Be;Re=1;var e=n,t=o,s=a,r="function"==typeof __webpack_require__?__non_webpack_require__:Ie,i=process.config&&process.config.variables||{},h=!!process.env.PREBUILDS_ONLY,c=process.versions.modules,l=process.versions&&process.versions.electron||process.env.ELECTRON_RUN_AS_NODE||"undefined"!=typeof window&&window.process&&"renderer"===window.process.type?"electron":process.versions&&process.versions.nw?"node-webkit":"node",f=process.env.npm_config_arch||s.arch(),u=process.env.npm_config_platform||s.platform(),d=process.env.LIBC||(function(t){return"linux"===t&&e.existsSync("/etc/alpine-release")}(u)?"musl":"glibc"),p=process.env.ARM_VERSION||("arm64"===f?"8":i.arm_version)||"",_=(process.versions.uv||"").split(".")[0];function g(e){return r(g.resolve(e))}function m(t){try{return e.readdirSync(t)}catch(e){return[]}}function y(e,s){var r=m(e).filter(s);return r[0]&&t.join(e,r[0])}function b(e){return/\.node$/.test(e)}function E(e){var t=e.split("-");if(2===t.length){var s=t[0],r=t[1].split("+");if(s&&r.length&&r.every(Boolean))return{name:e,platform:s,architectures:r}}}function S(e,t){return function(s){return null!=s&&s.platform===e&&s.architectures.includes(t)}}function v(e,t){return e.architectures.length-t.architectures.length}function k(e){var t=e.split("."),s={file:e,specificity:0};if("node"===t.pop()){for(var r=0;r<t.length;r++){var i=t[r];if("node"===i||"electron"===i||"node-webkit"===i)s.runtime=i;else if("napi"===i)s.napi=!0;else if("abi"===i.slice(0,3))s.abi=i.slice(3);else if("uv"===i.slice(0,2))s.uv=i.slice(2);else if("armv"===i.slice(0,4))s.armv=i.slice(4);else{if("glibc"!==i&&"musl"!==i)continue;s.libc=i}s.specificity++}return s}}function w(e,t){return function(s){return!(null==s||s.runtime&&s.runtime!==e&&!function(e){return"node"===e.runtime&&e.napi}(s)||s.abi&&s.abi!==t&&!s.napi||s.uv&&s.uv!==_||s.armv&&s.armv!==p||s.libc&&s.libc!==d)}}function x(e){return function(t,s){return t.runtime!==s.runtime?t.runtime===e?-1:1:t.abi!==s.abi?t.abi?-1:1:t.specificity!==s.specificity?t.specificity>s.specificity?-1:1:0}}return Be=g,g.resolve=g.path=function(e){e=t.resolve(e||".");try{var s=r(t.join(e,"package.json")).name.toUpperCase().replace(/-/g,"_");process.env[s+"_PREBUILD"]&&(e=process.env[s+"_PREBUILD"])}catch(e){}if(!h){var i=y(t.join(e,"build/Release"),b);if(i)return i;var n=y(t.join(e,"build/Debug"),b);if(n)return n}var o=T(e);if(o)return o;var a=T(t.dirname(process.execPath));if(a)return a;var g=["platform="+u,"arch="+f,"runtime="+l,"abi="+c,"uv="+_,p?"armv="+p:"","libc="+d,"node="+process.versions.node,process.versions.electron?"electron="+process.versions.electron:"","function"==typeof __webpack_require__?"webpack=true":""].filter(Boolean).join(" ");throw new Error("No native build was found for "+g+"\n    loaded from: "+e+"\n");function T(e){var s=m(t.join(e,"prebuilds")).map(E).filter(S(u,f)).sort(v)[0];if(s){var r=t.join(e,"prebuilds",s.name),i=m(r).map(k).filter(w(l,c)).sort(x(l))[0];return i?t.join(r,i.file):void 0}}},g.parseTags=k,g.matchTags=w,g.compareTags=x,g.parseTuple=E,g.matchTuple=S,g.compareTuples=v,Be}(),He.exports}const{EMPTY_BUFFER:$e}=Oe,We=Buffer[Symbol.species];function ze(e,t,s,r,i){for(let n=0;n<i;n++)s[r+n]=e[n]^t[3&n]}function je(e,t){for(let s=0;s<e.length;s++)e[s]^=t[3&s]}if(Le.exports={concat:function(e,t){if(0===e.length)return $e;if(1===e.length)return e[0];const s=Buffer.allocUnsafe(t);let r=0;for(let t=0;t<e.length;t++){const i=e[t];s.set(i,r),r+=i.length}return r<t?new We(s.buffer,s.byteOffset,r):s},mask:ze,toArrayBuffer:function(e){return e.length===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.length)},toBuffer:function e(t){if(e.readOnly=!0,Buffer.isBuffer(t))return t;let s;return t instanceof ArrayBuffer?s=new We(t):ArrayBuffer.isView(t)?s=new We(t.buffer,t.byteOffset,t.byteLength):(s=Buffer.from(t),e.readOnly=!1),s},unmask:je},!process.env.WS_NO_BUFFER_UTIL)try{const e=function(){if(De)return Ne.exports;De=1;try{Ne.exports=Fe()(__dirname)}catch(e){Ne.exports=(Pe||(Pe=1,Ue={mask:(e,t,s,r,i)=>{for(var n=0;n<i;n++)s[r+n]=e[n]^t[3&n]},unmask:(e,t)=>{const s=e.length;for(var r=0;r<s;r++)e[r]^=t[3&r]}}),Ue)}return Ne.exports}();Le.exports.mask=function(t,s,r,i,n){n<48?ze(t,s,r,i,n):e.mask(t,s,r,i,n)},Le.exports.unmask=function(t,s){t.length<32?je(t,s):e.unmask(t,s)}}catch(e){}var Ge=Le.exports;const Ve=Symbol("kDone"),qe=Symbol("kRun");const Ye=i,Qe=Ge,Ke=class{constructor(e){this[Ve]=()=>{this.pending--,this[qe]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[qe]()}[qe](){if(this.pending!==this.concurrency&&this.jobs.length){const e=this.jobs.shift();this.pending++,e(this[Ve])}}},{kStatusCode:Je}=Oe,Xe=Buffer[Symbol.species],Ze=Buffer.from([0,0,255,255]),et=Symbol("permessage-deflate"),tt=Symbol("total-length"),st=Symbol("callback"),rt=Symbol("buffers"),it=Symbol("error");let nt;var ot=class{constructor(e,t,s){if(this._maxPayload=0|s,this._options=e||{},this._threshold=void 0!==this._options.threshold?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!nt){const e=void 0!==this._options.concurrencyLimit?this._options.concurrencyLimit:10;nt=new Ke(e)}}static get extensionName(){return"permessage-deflate"}offer(){const e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:null==this._options.clientMaxWindowBits&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){const e=this._deflate[st];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){const t=this._options,s=e.find((e=>!(!1===t.serverNoContextTakeover&&e.server_no_context_takeover||e.server_max_window_bits&&(!1===t.serverMaxWindowBits||"number"==typeof t.serverMaxWindowBits&&t.serverMaxWindowBits>e.server_max_window_bits)||"number"==typeof t.clientMaxWindowBits&&!e.client_max_window_bits)));if(!s)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(s.server_no_context_takeover=!0),t.clientNoContextTakeover&&(s.client_no_context_takeover=!0),"number"==typeof t.serverMaxWindowBits&&(s.server_max_window_bits=t.serverMaxWindowBits),"number"==typeof t.clientMaxWindowBits?s.client_max_window_bits=t.clientMaxWindowBits:!0!==s.client_max_window_bits&&!1!==t.clientMaxWindowBits||delete s.client_max_window_bits,s}acceptAsClient(e){const t=e[0];if(!1===this._options.clientNoContextTakeover&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(t.client_max_window_bits){if(!1===this._options.clientMaxWindowBits||"number"==typeof this._options.clientMaxWindowBits&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"')}else"number"==typeof this._options.clientMaxWindowBits&&(t.client_max_window_bits=this._options.clientMaxWindowBits);return t}normalizeParams(e){return e.forEach((e=>{Object.keys(e).forEach((t=>{let s=e[t];if(s.length>1)throw new Error(`Parameter "${t}" must have only a single value`);if(s=s[0],"client_max_window_bits"===t){if(!0!==s){const e=+s;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${s}`);s=e}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${t}": ${s}`)}else if("server_max_window_bits"===t){const e=+s;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${s}`);s=e}else{if("client_no_context_takeover"!==t&&"server_no_context_takeover"!==t)throw new Error(`Unknown parameter "${t}"`);if(!0!==s)throw new TypeError(`Invalid value for parameter "${t}": ${s}`)}e[t]=s}))})),e}decompress(e,t,s){nt.add((r=>{this._decompress(e,t,((e,t)=>{r(),s(e,t)}))}))}compress(e,t,s){nt.add((r=>{this._compress(e,t,((e,t)=>{r(),s(e,t)}))}))}_decompress(e,t,s){const r=this._isServer?"client":"server";if(!this._inflate){const e=`${r}_max_window_bits`,t="number"!=typeof this.params[e]?Ye.Z_DEFAULT_WINDOWBITS:this.params[e];this._inflate=Ye.createInflateRaw({...this._options.zlibInflateOptions,windowBits:t}),this._inflate[et]=this,this._inflate[tt]=0,this._inflate[rt]=[],this._inflate.on("error",ct),this._inflate.on("data",ht)}this._inflate[st]=s,this._inflate.write(e),t&&this._inflate.write(Ze),this._inflate.flush((()=>{const e=this._inflate[it];if(e)return this._inflate.close(),this._inflate=null,void s(e);const i=Qe.concat(this._inflate[rt],this._inflate[tt]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[tt]=0,this._inflate[rt]=[],t&&this.params[`${r}_no_context_takeover`]&&this._inflate.reset()),s(null,i)}))}_compress(e,t,s){const r=this._isServer?"server":"client";if(!this._deflate){const e=`${r}_max_window_bits`,t="number"!=typeof this.params[e]?Ye.Z_DEFAULT_WINDOWBITS:this.params[e];this._deflate=Ye.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:t}),this._deflate[tt]=0,this._deflate[rt]=[],this._deflate.on("data",at)}this._deflate[st]=s,this._deflate.write(e),this._deflate.flush(Ye.Z_SYNC_FLUSH,(()=>{if(!this._deflate)return;let e=Qe.concat(this._deflate[rt],this._deflate[tt]);t&&(e=new Xe(e.buffer,e.byteOffset,e.length-4)),this._deflate[st]=null,this._deflate[tt]=0,this._deflate[rt]=[],t&&this.params[`${r}_no_context_takeover`]&&this._deflate.reset(),s(null,e)}))}};function at(e){this[rt].push(e),this[tt]+=e.length}function ht(e){this[tt]+=e.length,this[et]._maxPayload<1||this[tt]<=this[et]._maxPayload?this[rt].push(e):(this[it]=new RangeError("Max payload size exceeded"),this[it].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[it][Je]=1009,this.removeListener("data",ht),this.reset())}function ct(e){this[et]._inflate=null,e[Je]=1007,this[st](e)}var lt,ft,ut,dt={exports:{}},pt={exports:{}};const{isUtf8:_t}=h,{hasBlob:gt}=Oe;function mt(e){const t=e.length;let s=0;for(;s<t;)if(128&e[s])if(192==(224&e[s])){if(s+1===t||128!=(192&e[s+1])||192==(254&e[s]))return!1;s+=2}else if(224==(240&e[s])){if(s+2>=t||128!=(192&e[s+1])||128!=(192&e[s+2])||224===e[s]&&128==(224&e[s+1])||237===e[s]&&160==(224&e[s+1]))return!1;s+=3}else{if(240!=(248&e[s]))return!1;if(s+3>=t||128!=(192&e[s+1])||128!=(192&e[s+2])||128!=(192&e[s+3])||240===e[s]&&128==(240&e[s+1])||244===e[s]&&e[s+1]>143||e[s]>244)return!1;s+=4}else s++;return!0}if(dt.exports={isBlob:function(e){return gt&&"object"==typeof e&&"function"==typeof e.arrayBuffer&&"string"==typeof e.type&&"function"==typeof e.stream&&("Blob"===e[Symbol.toStringTag]||"File"===e[Symbol.toStringTag])},isValidStatusCode:function(e){return e>=1e3&&e<=1014&&1004!==e&&1005!==e&&1006!==e||e>=3e3&&e<=4999},isValidUTF8:mt,tokenChars:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0]},_t)dt.exports.isValidUTF8=function(e){return e.length<24?mt(e):_t(e)};else if(!process.env.WS_NO_UTF_8_VALIDATE)try{const e=function(){if(ut)return pt.exports;ut=1;try{pt.exports=Fe()(__dirname)}catch(e){pt.exports=ft?lt:(ft=1,lt=function(e){const t=e.length;let s=0;for(;s<t;)if(128&e[s])if(192==(224&e[s])){if(s+1===t||128!=(192&e[s+1])||192==(254&e[s]))return!1;s+=2}else if(224==(240&e[s])){if(s+2>=t||128!=(192&e[s+1])||128!=(192&e[s+2])||224===e[s]&&128==(224&e[s+1])||237===e[s]&&160==(224&e[s+1]))return!1;s+=3}else{if(240!=(248&e[s]))return!1;if(s+3>=t||128!=(192&e[s+1])||128!=(192&e[s+2])||128!=(192&e[s+3])||240===e[s]&&128==(240&e[s+1])||244===e[s]&&e[s+1]>143||e[s]>244)return!1;s+=4}else s++;return!0})}return pt.exports}();dt.exports.isValidUTF8=function(t){return t.length<32?mt(t):e(t)}}catch(e){}var yt=dt.exports;const{Writable:bt}=s,Et=ot,{BINARY_TYPES:St,EMPTY_BUFFER:vt,kStatusCode:kt,kWebSocket:wt}=Oe,{concat:xt,toArrayBuffer:Tt,unmask:Lt}=Ge,{isValidStatusCode:At,isValidUTF8:Ct}=yt,Ot=Buffer[Symbol.species];var Nt=class extends bt{constructor(e={}){super(),this._allowSynchronousEvents=void 0===e.allowSynchronousEvents||e.allowSynchronousEvents,this._binaryType=e.binaryType||St[0],this._extensions=e.extensions||{},this._isServer=!!e.isServer,this._maxPayload=0|e.maxPayload,this._skipUTF8Validation=!!e.skipUTF8Validation,this[wt]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._errored=!1,this._loop=!1,this._state=0}_write(e,t,s){if(8===this._opcode&&0==this._state)return s();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(s)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){const t=this._buffers[0];return this._buffers[0]=new Ot(t.buffer,t.byteOffset+e,t.length-e),new Ot(t.buffer,t.byteOffset,e)}const t=Buffer.allocUnsafe(e);do{const s=this._buffers[0],r=t.length-e;e>=s.length?t.set(this._buffers.shift(),r):(t.set(new Uint8Array(s.buffer,s.byteOffset,e),r),this._buffers[0]=new Ot(s.buffer,s.byteOffset+e,s.length-e)),e-=s.length}while(e>0);return t}startLoop(e){this._loop=!0;do{switch(this._state){case 0:this.getInfo(e);break;case 1:this.getPayloadLength16(e);break;case 2:this.getPayloadLength64(e);break;case 3:this.getMask();break;case 4:this.getData(e);break;case 5:case 6:return void(this._loop=!1)}}while(this._loop);this._errored||e()}getInfo(e){if(this._bufferedBytes<2)return void(this._loop=!1);const t=this.consume(2);if(48&t[0]){return void e(this.createError(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3"))}const s=!(64&~t[0]);if(!s||this._extensions[Et.extensionName]){if(this._fin=!(128&~t[0]),this._opcode=15&t[0],this._payloadLength=127&t[1],0===this._opcode){if(s){return void e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"))}if(!this._fragmented){return void e(this.createError(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE"))}this._opcode=this._fragmented}else if(1===this._opcode||2===this._opcode){if(this._fragmented){return void e(this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE"))}this._compressed=s}else{if(!(this._opcode>7&&this._opcode<11)){return void e(this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE"))}if(!this._fin){return void e(this.createError(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN"))}if(s){return void e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"))}if(this._payloadLength>125||8===this._opcode&&1===this._payloadLength){return void e(this.createError(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH"))}}if(this._fin||this._fragmented||(this._fragmented=this._opcode),this._masked=!(128&~t[1]),this._isServer){if(!this._masked){return void e(this.createError(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK"))}}else if(this._masked){return void e(this.createError(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK"))}126===this._payloadLength?this._state=1:127===this._payloadLength?this._state=2:this.haveLength(e)}else{e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"))}}getPayloadLength16(e){this._bufferedBytes<2?this._loop=!1:(this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength(e))}getPayloadLength64(e){if(this._bufferedBytes<8)return void(this._loop=!1);const t=this.consume(8),s=t.readUInt32BE(0);if(s>Math.pow(2,21)-1){e(this.createError(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH"))}else this._payloadLength=s*Math.pow(2,32)+t.readUInt32BE(4),this.haveLength(e)}haveLength(e){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0)){e(this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH"))}else this._masked?this._state=3:this._state=4}getMask(){this._bufferedBytes<4?this._loop=!1:(this._mask=this.consume(4),this._state=4)}getData(e){let t=vt;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength)return void(this._loop=!1);t=this.consume(this._payloadLength),this._masked&&this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3]&&Lt(t,this._mask)}if(this._opcode>7)this.controlMessage(t,e);else{if(this._compressed)return this._state=5,void this.decompress(t,e);t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage(e)}}decompress(e,t){this._extensions[Et.extensionName].decompress(e,this._fin,((e,s)=>{if(e)return t(e);if(s.length){if(this._messageLength+=s.length,this._messageLength>this._maxPayload&&this._maxPayload>0){const e=this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");return void t(e)}this._fragments.push(s)}this.dataMessage(t),0===this._state&&this.startLoop(t)}))}dataMessage(e){if(!this._fin)return void(this._state=0);const t=this._messageLength,s=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],2===this._opcode){let r;r="nodebuffer"===this._binaryType?xt(s,t):"arraybuffer"===this._binaryType?Tt(xt(s,t)):"blob"===this._binaryType?new Blob(s):s,this._allowSynchronousEvents?(this.emit("message",r,!0),this._state=0):(this._state=6,setImmediate((()=>{this.emit("message",r,!0),this._state=0,this.startLoop(e)})))}else{const r=xt(s,t);if(!this._skipUTF8Validation&&!Ct(r)){const t=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");return void e(t)}5===this._state||this._allowSynchronousEvents?(this.emit("message",r,!1),this._state=0):(this._state=6,setImmediate((()=>{this.emit("message",r,!1),this._state=0,this.startLoop(e)})))}}controlMessage(e,t){if(8!==this._opcode)this._allowSynchronousEvents?(this.emit(9===this._opcode?"ping":"pong",e),this._state=0):(this._state=6,setImmediate((()=>{this.emit(9===this._opcode?"ping":"pong",e),this._state=0,this.startLoop(t)})));else{if(0===e.length)this._loop=!1,this.emit("conclude",1005,vt),this.end();else{const s=e.readUInt16BE(0);if(!At(s)){const e=this.createError(RangeError,`invalid status code ${s}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");return void t(e)}const r=new Ot(e.buffer,e.byteOffset+2,e.length-2);if(!this._skipUTF8Validation&&!Ct(r)){const e=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");return void t(e)}this._loop=!1,this.emit("conclude",s,r),this.end()}this._state=0}}createError(e,t,s,r,i){this._loop=!1,this._errored=!0;const n=new e(s?`Invalid WebSocket frame: ${t}`:t);return Error.captureStackTrace(n,this.createError),n.code=i,n[kt]=r,n}};const{randomFillSync:It}=t,Bt=ot,{EMPTY_BUFFER:Rt,kWebSocket:Mt,NOOP:Ut}=Oe,{isBlob:Pt,isValidStatusCode:Dt}=yt,{mask:Ht,toBuffer:Ft}=Ge,$t=Symbol("kByteLength"),Wt=Buffer.alloc(4),zt=8192;let jt,Gt=zt;var Vt=class e{constructor(e,t,s){this._extensions=t||{},s&&(this._generateMask=s,this._maskBuffer=Buffer.alloc(4)),this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._queue=[],this._state=0,this.onerror=Ut,this[Mt]=void 0}static frame(e,t){let s,r,i=!1,n=2,o=!1;t.mask&&(s=t.maskBuffer||Wt,t.generateMask?t.generateMask(s):(Gt===zt&&(void 0===jt&&(jt=Buffer.alloc(zt)),It(jt,0,zt),Gt=0),s[0]=jt[Gt++],s[1]=jt[Gt++],s[2]=jt[Gt++],s[3]=jt[Gt++]),o=!(s[0]|s[1]|s[2]|s[3]),n=6),"string"==typeof e?r=t.mask&&!o||void 0===t[$t]?(e=Buffer.from(e)).length:t[$t]:(r=e.length,i=t.mask&&t.readOnly&&!o);let a=r;r>=65536?(n+=8,a=127):r>125&&(n+=2,a=126);const h=Buffer.allocUnsafe(i?r+n:n);return h[0]=t.fin?128|t.opcode:t.opcode,t.rsv1&&(h[0]|=64),h[1]=a,126===a?h.writeUInt16BE(r,2):127===a&&(h[2]=h[3]=0,h.writeUIntBE(r,4,6)),t.mask?(h[1]|=128,h[n-4]=s[0],h[n-3]=s[1],h[n-2]=s[2],h[n-1]=s[3],o?[h,e]:i?(Ht(e,s,h,n,r),[h]):(Ht(e,s,e,0,r),[h,e])):[h,e]}close(t,s,r,i){let n;if(void 0===t)n=Rt;else{if("number"!=typeof t||!Dt(t))throw new TypeError("First argument must be a valid error code number");if(void 0!==s&&s.length){const e=Buffer.byteLength(s);if(e>123)throw new RangeError("The message must not be greater than 123 bytes");n=Buffer.allocUnsafe(2+e),n.writeUInt16BE(t,0),"string"==typeof s?n.write(s,2):n.set(s,2)}else n=Buffer.allocUnsafe(2),n.writeUInt16BE(t,0)}const o={[$t]:n.length,fin:!0,generateMask:this._generateMask,mask:r,maskBuffer:this._maskBuffer,opcode:8,readOnly:!1,rsv1:!1};0!==this._state?this.enqueue([this.dispatch,n,!1,o,i]):this.sendFrame(e.frame(n,o),i)}ping(t,s,r){let i,n;if("string"==typeof t?(i=Buffer.byteLength(t),n=!1):Pt(t)?(i=t.size,n=!1):(i=(t=Ft(t)).length,n=Ft.readOnly),i>125)throw new RangeError("The data size must not be greater than 125 bytes");const o={[$t]:i,fin:!0,generateMask:this._generateMask,mask:s,maskBuffer:this._maskBuffer,opcode:9,readOnly:n,rsv1:!1};Pt(t)?0!==this._state?this.enqueue([this.getBlobData,t,!1,o,r]):this.getBlobData(t,!1,o,r):0!==this._state?this.enqueue([this.dispatch,t,!1,o,r]):this.sendFrame(e.frame(t,o),r)}pong(t,s,r){let i,n;if("string"==typeof t?(i=Buffer.byteLength(t),n=!1):Pt(t)?(i=t.size,n=!1):(i=(t=Ft(t)).length,n=Ft.readOnly),i>125)throw new RangeError("The data size must not be greater than 125 bytes");const o={[$t]:i,fin:!0,generateMask:this._generateMask,mask:s,maskBuffer:this._maskBuffer,opcode:10,readOnly:n,rsv1:!1};Pt(t)?0!==this._state?this.enqueue([this.getBlobData,t,!1,o,r]):this.getBlobData(t,!1,o,r):0!==this._state?this.enqueue([this.dispatch,t,!1,o,r]):this.sendFrame(e.frame(t,o),r)}send(e,t,s){const r=this._extensions[Bt.extensionName];let i,n,o=t.binary?2:1,a=t.compress;"string"==typeof e?(i=Buffer.byteLength(e),n=!1):Pt(e)?(i=e.size,n=!1):(i=(e=Ft(e)).length,n=Ft.readOnly),this._firstFragment?(this._firstFragment=!1,a&&r&&r.params[r._isServer?"server_no_context_takeover":"client_no_context_takeover"]&&(a=i>=r._threshold),this._compress=a):(a=!1,o=0),t.fin&&(this._firstFragment=!0);const h={[$t]:i,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:o,readOnly:n,rsv1:a};Pt(e)?0!==this._state?this.enqueue([this.getBlobData,e,this._compress,h,s]):this.getBlobData(e,this._compress,h,s):0!==this._state?this.enqueue([this.dispatch,e,this._compress,h,s]):this.dispatch(e,this._compress,h,s)}getBlobData(t,s,r,i){this._bufferedBytes+=r[$t],this._state=2,t.arrayBuffer().then((t=>{if(this._socket.destroyed){const e=new Error("The socket was closed while the blob was being read");return void process.nextTick(qt,this,e,i)}this._bufferedBytes-=r[$t];const n=Ft(t);s?this.dispatch(n,s,r,i):(this._state=0,this.sendFrame(e.frame(n,r),i),this.dequeue())})).catch((e=>{process.nextTick(Yt,this,e,i)}))}dispatch(t,s,r,i){if(!s)return void this.sendFrame(e.frame(t,r),i);const n=this._extensions[Bt.extensionName];this._bufferedBytes+=r[$t],this._state=1,n.compress(t,r.fin,((t,s)=>{if(this._socket.destroyed){qt(this,new Error("The socket was closed while data was being compressed"),i)}else this._bufferedBytes-=r[$t],this._state=0,r.readOnly=!1,this.sendFrame(e.frame(s,r),i),this.dequeue()}))}dequeue(){for(;0===this._state&&this._queue.length;){const e=this._queue.shift();this._bufferedBytes-=e[3][$t],Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[3][$t],this._queue.push(e)}sendFrame(e,t){2===e.length?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}};function qt(e,t,s){"function"==typeof s&&s(t);for(let s=0;s<e._queue.length;s++){const r=e._queue[s],i=r[r.length-1];"function"==typeof i&&i(t)}}function Yt(e,t,s){qt(e,t,s),e.onerror(t)}const{kForOnEventAttribute:Qt,kListener:Kt}=Oe,Jt=Symbol("kCode"),Xt=Symbol("kData"),Zt=Symbol("kError"),es=Symbol("kMessage"),ts=Symbol("kReason"),ss=Symbol("kTarget"),rs=Symbol("kType"),is=Symbol("kWasClean");class ns{constructor(e){this[ss]=null,this[rs]=e}get target(){return this[ss]}get type(){return this[rs]}}Object.defineProperty(ns.prototype,"target",{enumerable:!0}),Object.defineProperty(ns.prototype,"type",{enumerable:!0});class os extends ns{constructor(e,t={}){super(e),this[Jt]=void 0===t.code?0:t.code,this[ts]=void 0===t.reason?"":t.reason,this[is]=void 0!==t.wasClean&&t.wasClean}get code(){return this[Jt]}get reason(){return this[ts]}get wasClean(){return this[is]}}Object.defineProperty(os.prototype,"code",{enumerable:!0}),Object.defineProperty(os.prototype,"reason",{enumerable:!0}),Object.defineProperty(os.prototype,"wasClean",{enumerable:!0});class as extends ns{constructor(e,t={}){super(e),this[Zt]=void 0===t.error?null:t.error,this[es]=void 0===t.message?"":t.message}get error(){return this[Zt]}get message(){return this[es]}}Object.defineProperty(as.prototype,"error",{enumerable:!0}),Object.defineProperty(as.prototype,"message",{enumerable:!0});class hs extends ns{constructor(e,t={}){super(e),this[Xt]=void 0===t.data?null:t.data}get data(){return this[Xt]}}Object.defineProperty(hs.prototype,"data",{enumerable:!0});const cs={addEventListener(e,t,s={}){for(const r of this.listeners(e))if(!s[Qt]&&r[Kt]===t&&!r[Qt])return;let r;if("message"===e)r=function(e,s){const r=new hs("message",{data:s?e:e.toString()});r[ss]=this,fs(t,this,r)};else if("close"===e)r=function(e,s){const r=new os("close",{code:e,reason:s.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});r[ss]=this,fs(t,this,r)};else if("error"===e)r=function(e){const s=new as("error",{error:e,message:e.message});s[ss]=this,fs(t,this,s)};else{if("open"!==e)return;r=function(){const e=new ns("open");e[ss]=this,fs(t,this,e)}}r[Qt]=!!s[Qt],r[Kt]=t,s.once?this.once(e,r):this.on(e,r)},removeEventListener(e,t){for(const s of this.listeners(e))if(s[Kt]===t&&!s[Qt]){this.removeListener(e,s);break}}};var ls={CloseEvent:os,ErrorEvent:as,Event:ns,EventTarget:cs,MessageEvent:hs};function fs(e,t,s){"object"==typeof e&&e.handleEvent?e.handleEvent.call(e,s):e.call(t,s)}const{tokenChars:us}=yt;function ds(e,t,s){void 0===e[t]?e[t]=[s]:e[t].push(s)}var ps={format:function(e){return Object.keys(e).map((t=>{let s=e[t];return Array.isArray(s)||(s=[s]),s.map((e=>[t].concat(Object.keys(e).map((t=>{let s=e[t];return Array.isArray(s)||(s=[s]),s.map((e=>!0===e?t:`${t}=${e}`)).join("; ")}))).join("; "))).join(", ")})).join(", ")},parse:function(e){const t=Object.create(null);let s,r,i=Object.create(null),n=!1,o=!1,a=!1,h=-1,c=-1,l=-1,f=0;for(;f<e.length;f++)if(c=e.charCodeAt(f),void 0===s)if(-1===l&&1===us[c])-1===h&&(h=f);else if(0===f||32!==c&&9!==c){if(59!==c&&44!==c)throw new SyntaxError(`Unexpected character at index ${f}`);{if(-1===h)throw new SyntaxError(`Unexpected character at index ${f}`);-1===l&&(l=f);const r=e.slice(h,l);44===c?(ds(t,r,i),i=Object.create(null)):s=r,h=l=-1}}else-1===l&&-1!==h&&(l=f);else if(void 0===r)if(-1===l&&1===us[c])-1===h&&(h=f);else if(32===c||9===c)-1===l&&-1!==h&&(l=f);else if(59===c||44===c){if(-1===h)throw new SyntaxError(`Unexpected character at index ${f}`);-1===l&&(l=f),ds(i,e.slice(h,l),!0),44===c&&(ds(t,s,i),i=Object.create(null),s=void 0),h=l=-1}else{if(61!==c||-1===h||-1!==l)throw new SyntaxError(`Unexpected character at index ${f}`);r=e.slice(h,f),h=l=-1}else if(o){if(1!==us[c])throw new SyntaxError(`Unexpected character at index ${f}`);-1===h?h=f:n||(n=!0),o=!1}else if(a)if(1===us[c])-1===h&&(h=f);else if(34===c&&-1!==h)a=!1,l=f;else{if(92!==c)throw new SyntaxError(`Unexpected character at index ${f}`);o=!0}else if(34===c&&61===e.charCodeAt(f-1))a=!0;else if(-1===l&&1===us[c])-1===h&&(h=f);else if(-1===h||32!==c&&9!==c){if(59!==c&&44!==c)throw new SyntaxError(`Unexpected character at index ${f}`);{if(-1===h)throw new SyntaxError(`Unexpected character at index ${f}`);-1===l&&(l=f);let o=e.slice(h,l);n&&(o=o.replace(/\\/g,""),n=!1),ds(i,r,o),44===c&&(ds(t,s,i),i=Object.create(null),s=void 0),r=void 0,h=l=-1}}else-1===l&&(l=f);if(-1===h||a||32===c||9===c)throw new SyntaxError("Unexpected end of input");-1===l&&(l=f);const u=e.slice(h,l);return void 0===s?ds(t,u,i):(void 0===r?ds(i,u,!0):ds(i,r,n?u.replace(/\\/g,""):u),ds(t,s,i)),t}};const _s=c,gs=l,ms=f,ys=r,bs=u,{randomBytes:Es,createHash:Ss}=t,{URL:vs}=d,ks=ot,ws=Nt,xs=Vt,{isBlob:Ts}=yt,{BINARY_TYPES:Ls,EMPTY_BUFFER:As,GUID:Cs,kForOnEventAttribute:Os,kListener:Ns,kStatusCode:Is,kWebSocket:Bs,NOOP:Rs}=Oe,{EventTarget:{addEventListener:Ms,removeEventListener:Us}}=ls,{format:Ps,parse:Ds}=ps,{toBuffer:Hs}=Ge,Fs=3e4,$s=Symbol("kAborted"),Ws=[8,13],zs=["CONNECTING","OPEN","CLOSING","CLOSED"],js=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/;let Gs=class e extends _s{constructor(t,s,r){super(),this._binaryType=Ls[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=As,this._closeTimer=null,this._errorEmitted=!1,this._extensions={},this._paused=!1,this._protocol="",this._readyState=e.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,null!==t?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,void 0===s?s=[]:Array.isArray(s)||("object"==typeof s&&null!==s?(r=s,s=[]):s=[s]),qs(this,t,s,r)):(this._autoPong=r.autoPong,this._isServer=!0)}get binaryType(){return this._binaryType}set binaryType(e){Ls.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(t,s,r){const i=new ws({allowSynchronousEvents:r.allowSynchronousEvents,binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:r.maxPayload,skipUTF8Validation:r.skipUTF8Validation}),n=new xs(t,this._extensions,r.generateMask);this._receiver=i,this._sender=n,this._socket=t,i[Bs]=this,n[Bs]=this,t[Bs]=this,i.on("conclude",Zs),i.on("drain",er),i.on("error",tr),i.on("message",rr),i.on("ping",ir),i.on("pong",nr),n.onerror=ar,t.setTimeout&&t.setTimeout(0),t.setNoDelay&&t.setNoDelay(),s.length>0&&t.unshift(s),t.on("close",cr),t.on("data",lr),t.on("end",fr),t.on("error",ur),this._readyState=e.OPEN,this.emit("open")}emitClose(){if(!this._socket)return this._readyState=e.CLOSED,void this.emit("close",this._closeCode,this._closeMessage);this._extensions[ks.extensionName]&&this._extensions[ks.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=e.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(t,s){if(this.readyState!==e.CLOSED)if(this.readyState!==e.CONNECTING)this.readyState!==e.CLOSING?(this._readyState=e.CLOSING,this._sender.close(t,s,!this._isServer,(e=>{e||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())})),hr(this)):this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end();else{const e="WebSocket was closed before the connection was established";Js(this,this._req,e)}}pause(){this.readyState!==e.CONNECTING&&this.readyState!==e.CLOSED&&(this._paused=!0,this._socket.pause())}ping(t,s,r){if(this.readyState===e.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof t?(r=t,t=s=void 0):"function"==typeof s&&(r=s,s=void 0),"number"==typeof t&&(t=t.toString()),this.readyState===e.OPEN?(void 0===s&&(s=!this._isServer),this._sender.ping(t||As,s,r)):Xs(this,t,r)}pong(t,s,r){if(this.readyState===e.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof t?(r=t,t=s=void 0):"function"==typeof s&&(r=s,s=void 0),"number"==typeof t&&(t=t.toString()),this.readyState===e.OPEN?(void 0===s&&(s=!this._isServer),this._sender.pong(t||As,s,r)):Xs(this,t,r)}resume(){this.readyState!==e.CONNECTING&&this.readyState!==e.CLOSED&&(this._paused=!1,this._receiver._writableState.needDrain||this._socket.resume())}send(t,s,r){if(this.readyState===e.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof s&&(r=s,s={}),"number"==typeof t&&(t=t.toString()),this.readyState!==e.OPEN)return void Xs(this,t,r);const i={binary:"string"!=typeof t,mask:!this._isServer,compress:!0,fin:!0,...s};this._extensions[ks.extensionName]||(i.compress=!1),this._sender.send(t||As,i,r)}terminate(){if(this.readyState!==e.CLOSED)if(this.readyState!==e.CONNECTING)this._socket&&(this._readyState=e.CLOSING,this._socket.destroy());else{const e="WebSocket was closed before the connection was established";Js(this,this._req,e)}}};Object.defineProperty(Gs,"CONNECTING",{enumerable:!0,value:zs.indexOf("CONNECTING")}),Object.defineProperty(Gs.prototype,"CONNECTING",{enumerable:!0,value:zs.indexOf("CONNECTING")}),Object.defineProperty(Gs,"OPEN",{enumerable:!0,value:zs.indexOf("OPEN")}),Object.defineProperty(Gs.prototype,"OPEN",{enumerable:!0,value:zs.indexOf("OPEN")}),Object.defineProperty(Gs,"CLOSING",{enumerable:!0,value:zs.indexOf("CLOSING")}),Object.defineProperty(Gs.prototype,"CLOSING",{enumerable:!0,value:zs.indexOf("CLOSING")}),Object.defineProperty(Gs,"CLOSED",{enumerable:!0,value:zs.indexOf("CLOSED")}),Object.defineProperty(Gs.prototype,"CLOSED",{enumerable:!0,value:zs.indexOf("CLOSED")}),["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach((e=>{Object.defineProperty(Gs.prototype,e,{enumerable:!0})})),["open","error","close","message"].forEach((e=>{Object.defineProperty(Gs.prototype,`on${e}`,{enumerable:!0,get(){for(const t of this.listeners(e))if(t[Os])return t[Ns];return null},set(t){for(const t of this.listeners(e))if(t[Os]){this.removeListener(e,t);break}"function"==typeof t&&this.addEventListener(e,t,{[Os]:!0})}})})),Gs.prototype.addEventListener=Ms,Gs.prototype.removeEventListener=Us;var Vs=Gs;function qs(e,t,s,r){const i={allowSynchronousEvents:!0,autoPong:!0,protocolVersion:Ws[1],maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...r,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:"GET",host:void 0,path:void 0,port:void 0};if(e._autoPong=i.autoPong,!Ws.includes(i.protocolVersion))throw new RangeError(`Unsupported protocol version: ${i.protocolVersion} (supported versions: ${Ws.join(", ")})`);let n;if(t instanceof vs)n=t;else try{n=new vs(t)}catch(e){throw new SyntaxError(`Invalid URL: ${t}`)}"http:"===n.protocol?n.protocol="ws:":"https:"===n.protocol&&(n.protocol="wss:"),e._url=n.href;const o="wss:"===n.protocol,a="ws+unix:"===n.protocol;let h;if("ws:"===n.protocol||o||a?a&&!n.pathname?h="The URL's pathname is empty":n.hash&&(h="The URL contains a fragment identifier"):h='The URL\'s protocol must be one of "ws:", "wss:", "http:", "https", or "ws+unix:"',h){const t=new SyntaxError(h);if(0===e._redirects)throw t;return void Ys(e,t)}const c=o?443:80,l=Es(16).toString("base64"),f=o?gs.request:ms.request,u=new Set;let d,p;if(i.createConnection=i.createConnection||(o?Ks:Qs),i.defaultPort=i.defaultPort||c,i.port=n.port||c,i.host=n.hostname.startsWith("[")?n.hostname.slice(1,-1):n.hostname,i.headers={...i.headers,"Sec-WebSocket-Version":i.protocolVersion,"Sec-WebSocket-Key":l,Connection:"Upgrade",Upgrade:"websocket"},i.path=n.pathname+n.search,i.timeout=i.handshakeTimeout,i.perMessageDeflate&&(d=new ks(!0!==i.perMessageDeflate?i.perMessageDeflate:{},!1,i.maxPayload),i.headers["Sec-WebSocket-Extensions"]=Ps({[ks.extensionName]:d.offer()})),s.length){for(const e of s){if("string"!=typeof e||!js.test(e)||u.has(e))throw new SyntaxError("An invalid or duplicated subprotocol was specified");u.add(e)}i.headers["Sec-WebSocket-Protocol"]=s.join(",")}if(i.origin&&(i.protocolVersion<13?i.headers["Sec-WebSocket-Origin"]=i.origin:i.headers.Origin=i.origin),(n.username||n.password)&&(i.auth=`${n.username}:${n.password}`),a){const e=i.path.split(":");i.socketPath=e[0],i.path=e[1]}if(i.followRedirects){if(0===e._redirects){e._originalIpc=a,e._originalSecure=o,e._originalHostOrSocketPath=a?i.socketPath:n.host;const t=r&&r.headers;if(r={...r,headers:{}},t)for(const[e,s]of Object.entries(t))r.headers[e.toLowerCase()]=s}else if(0===e.listenerCount("redirect")){const t=a?!!e._originalIpc&&i.socketPath===e._originalHostOrSocketPath:!e._originalIpc&&n.host===e._originalHostOrSocketPath;(!t||e._originalSecure&&!o)&&(delete i.headers.authorization,delete i.headers.cookie,t||delete i.headers.host,i.auth=void 0)}i.auth&&!r.headers.authorization&&(r.headers.authorization="Basic "+Buffer.from(i.auth).toString("base64")),p=e._req=f(i),e._redirects&&e.emit("redirect",e.url,p)}else p=e._req=f(i);i.timeout&&p.on("timeout",(()=>{Js(e,p,"Opening handshake has timed out")})),p.on("error",(t=>{null===p||p[$s]||(p=e._req=null,Ys(e,t))})),p.on("response",(n=>{const o=n.headers.location,a=n.statusCode;if(o&&i.followRedirects&&a>=300&&a<400){if(++e._redirects>i.maxRedirects)return void Js(e,p,"Maximum redirects exceeded");let n;p.abort();try{n=new vs(o,t)}catch(t){const s=new SyntaxError(`Invalid URL: ${o}`);return void Ys(e,s)}qs(e,n,s,r)}else e.emit("unexpected-response",p,n)||Js(e,p,`Unexpected server response: ${n.statusCode}`)})),p.on("upgrade",((t,s,r)=>{if(e.emit("upgrade",t),e.readyState!==Gs.CONNECTING)return;p=e._req=null;const n=t.headers.upgrade;if(void 0===n||"websocket"!==n.toLowerCase())return void Js(e,s,"Invalid Upgrade header");const o=Ss("sha1").update(l+Cs).digest("base64");if(t.headers["sec-websocket-accept"]!==o)return void Js(e,s,"Invalid Sec-WebSocket-Accept header");const a=t.headers["sec-websocket-protocol"];let h;if(void 0!==a?u.size?u.has(a)||(h="Server sent an invalid subprotocol"):h="Server sent a subprotocol but none was requested":u.size&&(h="Server sent no subprotocol"),h)return void Js(e,s,h);a&&(e._protocol=a);const c=t.headers["sec-websocket-extensions"];if(void 0!==c){if(!d){return void Js(e,s,"Server sent a Sec-WebSocket-Extensions header but no extension was requested")}let t;try{t=Ds(c)}catch(t){return void Js(e,s,"Invalid Sec-WebSocket-Extensions header")}const r=Object.keys(t);if(1!==r.length||r[0]!==ks.extensionName){return void Js(e,s,"Server indicated an extension that was not requested")}try{d.accept(t[ks.extensionName])}catch(t){return void Js(e,s,"Invalid Sec-WebSocket-Extensions header")}e._extensions[ks.extensionName]=d}e.setSocket(s,r,{allowSynchronousEvents:i.allowSynchronousEvents,generateMask:i.generateMask,maxPayload:i.maxPayload,skipUTF8Validation:i.skipUTF8Validation})})),i.finishRequest?i.finishRequest(p,e):p.end()}function Ys(e,t){e._readyState=Gs.CLOSING,e._errorEmitted=!0,e.emit("error",t),e.emitClose()}function Qs(e){return e.path=e.socketPath,ys.connect(e)}function Ks(e){return e.path=void 0,e.servername||""===e.servername||(e.servername=ys.isIP(e.host)?"":e.host),bs.connect(e)}function Js(e,t,s){e._readyState=Gs.CLOSING;const r=new Error(s);Error.captureStackTrace(r,Js),t.setHeader?(t[$s]=!0,t.abort(),t.socket&&!t.socket.destroyed&&t.socket.destroy(),process.nextTick(Ys,e,r)):(t.destroy(r),t.once("error",e.emit.bind(e,"error")),t.once("close",e.emitClose.bind(e)))}function Xs(e,t,s){if(t){const s=Ts(t)?t.size:Hs(t).length;e._socket?e._sender._bufferedBytes+=s:e._bufferedAmount+=s}if(s){const t=new Error(`WebSocket is not open: readyState ${e.readyState} (${zs[e.readyState]})`);process.nextTick(s,t)}}function Zs(e,t){const s=this[Bs];s._closeFrameReceived=!0,s._closeMessage=t,s._closeCode=e,void 0!==s._socket[Bs]&&(s._socket.removeListener("data",lr),process.nextTick(or,s._socket),1005===e?s.close():s.close(e,t))}function er(){const e=this[Bs];e.isPaused||e._socket.resume()}function tr(e){const t=this[Bs];void 0!==t._socket[Bs]&&(t._socket.removeListener("data",lr),process.nextTick(or,t._socket),t.close(e[Is])),t._errorEmitted||(t._errorEmitted=!0,t.emit("error",e))}function sr(){this[Bs].emitClose()}function rr(e,t){this[Bs].emit("message",e,t)}function ir(e){const t=this[Bs];t._autoPong&&t.pong(e,!this._isServer,Rs),t.emit("ping",e)}function nr(e){this[Bs].emit("pong",e)}function or(e){e.resume()}function ar(e){const t=this[Bs];t.readyState!==Gs.CLOSED&&(t.readyState===Gs.OPEN&&(t._readyState=Gs.CLOSING,hr(t)),this._socket.end(),t._errorEmitted||(t._errorEmitted=!0,t.emit("error",e)))}function hr(e){e._closeTimer=setTimeout(e._socket.destroy.bind(e._socket),Fs)}function cr(){const e=this[Bs];let t;this.removeListener("close",cr),this.removeListener("data",lr),this.removeListener("end",fr),e._readyState=Gs.CLOSING,this._readableState.endEmitted||e._closeFrameReceived||e._receiver._writableState.errorEmitted||null===(t=e._socket.read())||e._receiver.write(t),e._receiver.end(),this[Bs]=void 0,clearTimeout(e._closeTimer),e._receiver._writableState.finished||e._receiver._writableState.errorEmitted?e.emitClose():(e._receiver.on("error",sr),e._receiver.on("finish",sr))}function lr(e){this[Bs]._receiver.write(e)||this.pause()}function fr(){const e=this[Bs];e._readyState=Gs.CLOSING,e._receiver.end(),this.end()}function ur(){const e=this[Bs];this.removeListener("error",ur),this.on("error",Rs),e&&(e._readyState=Gs.CLOSING,this.destroy())}var dr=V(Vs);const{tokenChars:pr}=yt;var _r={parse:function(e){const t=new Set;let s=-1,r=-1,i=0;for(;i<e.length;i++){const n=e.charCodeAt(i);if(-1===r&&1===pr[n])-1===s&&(s=i);else if(0===i||32!==n&&9!==n){if(44!==n)throw new SyntaxError(`Unexpected character at index ${i}`);{if(-1===s)throw new SyntaxError(`Unexpected character at index ${i}`);-1===r&&(r=i);const n=e.slice(s,r);if(t.has(n))throw new SyntaxError(`The "${n}" subprotocol is duplicated`);t.add(n),s=r=-1}}else-1===r&&-1!==s&&(r=i)}if(-1===s||-1!==r)throw new SyntaxError("Unexpected end of input");const n=e.slice(s,i);if(t.has(n))throw new SyntaxError(`The "${n}" subprotocol is duplicated`);return t.add(n),t}};const gr=c,mr=f,{createHash:yr}=t,br=ps,Er=ot,Sr=_r,vr=Vs,{GUID:kr,kWebSocket:wr}=Oe,xr=/^[+/0-9A-Za-z]{22}==$/;function Tr(e){e._state=2,e.emit("close")}function Lr(){this.destroy()}function Ar(e,t,s,r){s=s||mr.STATUS_CODES[t],r={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(s),...r},e.once("finish",e.destroy),e.end(`HTTP/1.1 ${t} ${mr.STATUS_CODES[t]}\r\n`+Object.keys(r).map((e=>`${e}: ${r[e]}`)).join("\r\n")+"\r\n\r\n"+s)}function Cr(e,t,s,r,i){if(e.listenerCount("wsClientError")){const r=new Error(i);Error.captureStackTrace(r,Cr),e.emit("wsClientError",r,s,t)}else Ar(s,r,i)}var Or=V(class extends gr{constructor(e,t){if(super(),null==(e={allowSynchronousEvents:!0,autoPong:!0,maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,WebSocket:vr,...e}).port&&!e.server&&!e.noServer||null!=e.port&&(e.server||e.noServer)||e.server&&e.noServer)throw new TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(null!=e.port?(this._server=mr.createServer(((e,t)=>{const s=mr.STATUS_CODES[426];t.writeHead(426,{"Content-Length":s.length,"Content-Type":"text/plain"}),t.end(s)})),this._server.listen(e.port,e.host,e.backlog,t)):e.server&&(this._server=e.server),this._server){const e=this.emit.bind(this,"connection");this._removeListeners=function(e,t){for(const s of Object.keys(t))e.on(s,t[s]);return function(){for(const s of Object.keys(t))e.removeListener(s,t[s])}}(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(t,s,r)=>{this.handleUpgrade(t,s,r,e)}})}!0===e.perMessageDeflate&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set,this._shouldEmitClose=!1),this.options=e,this._state=0}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(2===this._state)return e&&this.once("close",(()=>{e(new Error("The server is not running"))})),void process.nextTick(Tr,this);if(e&&this.once("close",e),1!==this._state)if(this._state=1,this.options.noServer||this.options.server)this._server&&(this._removeListeners(),this._removeListeners=this._server=null),this.clients&&this.clients.size?this._shouldEmitClose=!0:process.nextTick(Tr,this);else{const e=this._server;this._removeListeners(),this._removeListeners=this._server=null,e.close((()=>{Tr(this)}))}}shouldHandle(e){if(this.options.path){const t=e.url.indexOf("?");if((-1!==t?e.url.slice(0,t):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,t,s,r){t.on("error",Lr);const i=e.headers["sec-websocket-key"],n=e.headers.upgrade,o=+e.headers["sec-websocket-version"];if("GET"!==e.method){return void Cr(this,e,t,405,"Invalid HTTP method")}if(void 0===n||"websocket"!==n.toLowerCase()){return void Cr(this,e,t,400,"Invalid Upgrade header")}if(void 0===i||!xr.test(i)){return void Cr(this,e,t,400,"Missing or invalid Sec-WebSocket-Key header")}if(8!==o&&13!==o){return void Cr(this,e,t,400,"Missing or invalid Sec-WebSocket-Version header")}if(!this.shouldHandle(e))return void Ar(t,400);const a=e.headers["sec-websocket-protocol"];let h=new Set;if(void 0!==a)try{h=Sr.parse(a)}catch(s){return void Cr(this,e,t,400,"Invalid Sec-WebSocket-Protocol header")}const c=e.headers["sec-websocket-extensions"],l={};if(this.options.perMessageDeflate&&void 0!==c){const s=new Er(this.options.perMessageDeflate,!0,this.options.maxPayload);try{const e=br.parse(c);e[Er.extensionName]&&(s.accept(e[Er.extensionName]),l[Er.extensionName]=s)}catch(s){return void Cr(this,e,t,400,"Invalid or unacceptable Sec-WebSocket-Extensions header")}}if(this.options.verifyClient){const n={origin:e.headers[""+(8===o?"sec-websocket-origin":"origin")],secure:!(!e.socket.authorized&&!e.socket.encrypted),req:e};if(2===this.options.verifyClient.length)return void this.options.verifyClient(n,((n,o,a,c)=>{if(!n)return Ar(t,o||401,a,c);this.completeUpgrade(l,i,h,e,t,s,r)}));if(!this.options.verifyClient(n))return Ar(t,401)}this.completeUpgrade(l,i,h,e,t,s,r)}completeUpgrade(e,t,s,r,i,n,o){if(!i.readable||!i.writable)return i.destroy();if(i[wr])throw new Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>0)return Ar(i,503);const a=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${yr("sha1").update(t+kr).digest("base64")}`],h=new this.options.WebSocket(null,void 0,this.options);if(s.size){const e=this.options.handleProtocols?this.options.handleProtocols(s,r):s.values().next().value;e&&(a.push(`Sec-WebSocket-Protocol: ${e}`),h._protocol=e)}if(e[Er.extensionName]){const t=e[Er.extensionName].params,s=br.format({[Er.extensionName]:[t]});a.push(`Sec-WebSocket-Extensions: ${s}`),h._extensions=e}this.emit("headers",a,r),i.write(a.concat("\r\n").join("\r\n")),i.removeListener("error",Lr),h.setSocket(i,n,{allowSynchronousEvents:this.options.allowSynchronousEvents,maxPayload:this.options.maxPayload,skipUTF8Validation:this.options.skipUTF8Validation}),this.clients&&(this.clients.add(h),h.on("close",(()=>{this.clients.delete(h),this._shouldEmitClose&&!this.clients.size&&process.nextTick(Tr,this)}))),o(h,r)}});let Nr={clientTracking:!1,port:0,httpServer:null,congPort:0,timeout:5e4,showMessage:"none",showMetric:0,showChannel:0,monitorPeriod:5e3,fileLogger:{connection:{use:!1,path:"connection.log"},auth:{use:!1,path:"auth.log"},attack:{use:!1,path:"attack.log"}},useQuota:{signalSize:!1,publishCounter:!1,trafficRate:!1,disconnect:!1},defaultQuotaIndex:3,adminLevel:255,debug:{slow:!1,delay:500,showAuthInfo:!1},retain:{isAvailable:!0,limitSize:1e5,limitCounter:1e3},auth:{delay_auth_fail:1e3},memberOnly:!1};const Ir=new TextDecoder,Br=b;class Rr{constructor(e,t){this.socket=e,e.isAlive=!0,e.txCounter=0,e.rxCounter=0,e.openTime=Date.now(),this.boho=new he,this.encMode=fe.AUTO,this.channels=new Set,this.retain_signal=new Map,this.ssid=Rr.ssid++,this.manager=t,this.cid,this.did,this.uid,this.nick="",this.lastEchoMessage="N",this.privateNode=!1,this.HOME_CHANNEL="",this.level=Nr.defaultQuotaIndex,this.quota=_e[this.level],this.isAdmin=!1,this.state,this.stateLog=[],this.setState(le.INIT)}static ssid=1;setState(e){this.state=e,Nr.debug.showAuthInfo&&(this.stateLog.push(e),console.log(this.stateLog.join(">")))}getState(){return this.state}getStateName(){return le[this.state].toLowerCase()}showMessageLog(e,t){let s=this.boho.isAuthorized?`did: ${this.did} ${this.cid}@`:`${this.cid}@`;if(t){let t=pe[e[0]];t||(t=se[e[0]]),t=" ["+t+"]",e.byteLength>40?console.log(s+t+" LEN:",e.length):console.log(s+t,e)}else console.log(s+" [TEXT] %s",e)}rxQuotaChecker(e){let t=e.byteLength;return this.manager.rxBytes+=t,!(Nr.useQuota.signalSize&&t>this.quota.signalSize)||(console.log("## quota: size over"),this.send(Buffer.from([pe.OVER_SIZE])),Nr.useQuota.disconnect&&this.close(),!1)}onTimeDelayMessage(e,t=!0){setTimeout((()=>{this.onSocketMessage(e,t)}),Nr.debug.delay)}onSocketMessage(e,s=!0){if(this.receiveMonitor(),!this.rxQuotaChecker(e))return;let r,i;if("message"===Nr.showMessage&&this.showMessageLog(e,s),s){if(r=e[0],r===se.ENC_488){try{i=this.boho.decrypt_488(e)}catch(e){return void console.log("-- E488 DEC_FAIL",e)}if(!i)return;r=i[0],e=i}else if(r===se.ENC_E2E){try{i=this.boho.decrypt_488(e)}catch(e){return}if(!i)return;r=i[0],e.set(i,ne.ENC_488),e=e.subarray(ne.ENC_488)}switch(r){case pe.PING:this.pong();break;case pe.PONG:break;case pe.CID_REQ:this.state<le.SENT_SERVER_READY&&this.close(),this.cid||(this.cid="?"+t.webcrypto.getRandomValues(Buffer.alloc(3)).toString("base64url"),this.manager.cid2remote.set(this.cid,this)),this.send_enc_mode(x(Br("#cid_ack","8",pe.CID_RES),Br("#cid",this.cid))),this.setState(le.CID_READY);break;case pe.ECHO:try{let t=Ir.decode(e.subarray(1));this.lastEchoMessage=t}catch(e){}this.send(e,s);break;case pe.IAM:if(e.byteLength>1){let t=e.subarray(1);this.nick=Ir.decode(t),console.log("iam nick reset",this.nick)}this.iamResponse();break;case pe.SIGNAL_E2E:case pe.SIGNAL:if(e.byteLength>=3){let t=e.readUInt8(1);if(e.byteLength>=t+2){let s=e.subarray(2,2+t);s=Ir.decode(s),this.manager.sender(s,this,e)}}break;case pe.UNSUBSCRIBE:if(2==e.byteLength)this.manager.unsubscribe([""],this);else if(e.byteLength>=3){let t=e.readUInt8(1);if(e.byteLength==t+2){let s=e.subarray(2,2+t);s=Ir.decode(s);let r=s.split(",");this.manager.unsubscribe(r,this)}}break;case pe.SUBSCRIBE:if(e.byteLength>=3){let t=e.readUInt8(1);if(e.byteLength==t+2){let s=e.subarray(2,2+t);s=Ir.decode(s);let r=s.split(",");this.manager.subscribe(r,this)}}break;case pe.SUBSCRIBE_REQ:if(e.byteLength>=6){let t=e.readUInt16BE(1),s=e.readUInt16BE(3);if(e.byteLength==s+5){let r=e.subarray(5,5+s);r=Ir.decode(r);let i=r.split(",");this.manager.subscribe(i,this),this.response(t,0)}else this.response(t,255)}break;case pe.REQUEST:try{let t=T(e);if(t){if(!t.target||!t.topic)return;this.manager.server.apiNames.has(t.target)&&this.manager.server.emit(t.target,this,t)}}catch(e){console.log("request catch error",e)}break;case pe.CLOSE:if(e.byteLength>1){let t=Ir.decode(e.subarray(1));console.log(">> CLOSE reason:",t),this.close()}break;case se.AUTH_REQ:if(!this.manager.authManager)return;this.state<le.SENT_SERVER_READY&&this.close(),this.setState(le.RECV_AUTH_REQ);let r=this.boho.auth_nonce();this.send(r),this.setState(le.SENT_SERVER_NONCE);break;case se.AUTH_HMAC:if(!this.manager.authManager)return;return this.state<le.SENT_SERVER_NONCE&&this.close(),this.setState(le.RECV_AUTH_HMAC),void this.manager.authManager.verify_auth_hmac(e,this).then((e=>{e&&this.manager.deligateSignal(remote,"@$name",e.name)})).catch((e=>{}))}}else try{let t=Ir.decode(e);this.manager.server.emit("text_message",t,this)}catch(e){}}response(e,t,s){s?this.send_enc_mode(x(Br("#type","8",pe.RESPONSE_MBP),Br("status","8",t),Br("mid","16",e),Br("body",s))):this.send_enc_mode(x(Br("#type","8",pe.RESPONSE_MBP),Br("status","8",t),Br("mid","16",e)))}send_enc_mode(e,t=!1){if((this.encMode===fe.YES||this.encMode===fe.AUTO&&!this.TLS&&this.boho.isAuthorized)&&(t=!0),t&&e[0]==pe.SIGNAL_E2E){let t=e[1],s=this.boho.encrypt_488(e.subarray(0,3+t));s[0]=se.ENC_E2E;let r=Buffer.concat([s,e.subarray(3+t)]);this.send(r)}else if(t){let t=this.boho.encrypt_488(e);t&&this.send(t)}else this.send(e)}iamResponse(e=""){if(""==e){let t=[];for(let e of this.channels.keys())t.push(e);e={ssid:this.ssid,uid:this.uid,cid:this.cid,did:this.did,nick:this.nick,ip:this.ip,tag:t}}let t=x(Br("#MsgType","8",pe.IAM_RES),Br("#info",e));this.send_enc_mode(t)}}const Mr=new TextDecoder;class Ur extends Rr{constructor(e,t,s){super(e,s),this.socketType=e.socketType,"websocket"===this.socketType?(this.TLS="https"===t.headers["x-forwarded-proto"],this.ip=this.getRemoteIP(t)):(this.TLS=!1,this.ip=this.getRemoteIP(e.remoteAddress)),!function(e){if(0===e.indexOf("0.0.0.0"))return!0;if(0===e.indexOf("127.0.0.1"))return!0;if(0===e.indexOf("192.168."))return!0;if(0===e.indexOf("10."))return!0;if(0===e.indexOf("172.")){if(0===e.indexOf("172.16."))return!0;if(0===e.indexOf("172.17."))return!0;if(0===e.indexOf("172.18."))return!0;if(0===e.indexOf("172.19."))return!0;if(0===e.indexOf("172.20."))return!0;if(0===e.indexOf("172.21."))return!0;if(0===e.indexOf("172.22."))return!0;if(0===e.indexOf("172.23."))return!0;if(0===e.indexOf("172.24."))return!0;if(0===e.indexOf("172.25."))return!0;if(0===e.indexOf("172.26."))return!0;if(0===e.indexOf("172.27."))return!0;if(0===e.indexOf("172.28."))return!0;if(0===e.indexOf("172.29."))return!0;if(0===e.indexOf("172.30."))return!0;if(0===e.indexOf("172.31."))return!0}return!1}(this.ip)?this.HOME_CHANNEL="IP:"+function(e){let t=e.split(".");return Buffer.from(t).toString("hex")}(this.ip):(this.HOME_CHANNEL="PRIVATE:",this.privateNode=!0),"websocket"===this.socketType?(Nr.debug.slow?e.on("message",this.onTimeDelayMessage.bind(this)):e.on("message",this.onSocketMessage.bind(this)),e.on("pong",this.receiveMonitor.bind(this)),e.on("ping",this.receiveMonitor.bind(this)),e.on("error",(e=>{console.log("Websocket error",e,e.code)})),e.onclose=e=>{this.manager.removeRemote(this)}):(this.congRx=new Te,e.on("data",(e=>{this.congRx.write(e)})),this.congRx.on("wrong",this.onWrongCongPacketMessage.bind(this)),Nr.debug.slow?this.congRx.on("data",this.onTimeDelayMessage.bind(this)):this.congRx.on("data",this.onSocketMessage.bind(this)),e.on("error",(e=>{console.log("TCP Socket error",e)})),e.on("close",(e=>{this.manager.removeRemote(this)})))}onWrongCongPacketMessage(e){if(this.cid);else{let t="";try{t=Mr.decode(e)}catch(s){t+="Len: "+e.byteLength}if(this.manager.attackLogger){let e=`> ${this.ssid} ${this.ip} ${t}`;this.manager.attackLogger.log(e)}this.close(!0)}}permissionChecker(){this.socket.bytesWritten||this.socket._socket,this.socket.bytesRead||this.socket._socket}receiveMonitor(){this.socket.rxCounter++,this.socket.isAlive=!0}isConnectionHTTPS(e){return e.headers["x-forwarded-proto"]}getRemoteIP(e){let t;return e&&e.headers?(t=e.headers["x-forwarded-for"],null==t&&(t=e.socket.remoteAddress)):t=e,t?(0==t.indexOf("::ffff:")&&(t=t.substring(7)),"::1"==t&&(t="127.0.0.1")):t="0.0.0.0",t}ping(){"websocket"===this.socketType?(this.socket.ping(),this.socket.txCounter++):this.send(Buffer.from([pe.PING]))}pong(){"websocket"===this.socketType?(this.socket.pong(),this.socket.txCounter++):this.send(Buffer.from([pe.PONG]))}getTraffic(){this.socket.bytesWritten||this.socket._socket,this.socket.bytesRead||this.socket._socket,this.socket.txCounter,this.socket.rxCounter}close(e=!1){this.getTraffic(),"websocket"===this.socketType?e?this.socket.terminate():this.socket.close():e?this.socket.destroy():this.socket.end()}send(e,t){this.manager.txBytes+=e.byteLength,this.socket.txCounter++,"websocket"===this.socketType?1===this.socket.readyState?null!=t?this.socket.send(e,{binary:t}):this.socket.send(e):this.close(!0):"open"==this.socket.readyState?this.socket.write(xe(e)):this.close(!0)}}const Pr=new Intl.DateTimeFormat("ko-KR",{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",hour12:!1,timeZone:"Asia/Seoul"});class Dr{constructor(e){this.file=n.openSync(e,"a+"),console.log("new FileLogger logFile: ",e,this.file)}log(e){let t=Pr.format(new Date)+" "+e+"\n";n.write(this.file,t,(e=>{if(e)throw e}))}}class Hr{constructor(e){this.manager=e,this.metricsPack={remotes:[0],channels:[0],txBytes:[0],rxBytes:[0],unixTime:[Math.floor(Date.now()/1e3)],period:0},this.tickId=setInterval((e=>{this.metricsPack.remotes.push(this.manager.remotes.size),this.metricsPack.remotes.length>10&&this.metricsPack.remotes.shift(),this.metricsPack.channels.push(this.manager.channel_map.size),this.metricsPack.channels.length>10&&this.metricsPack.channels.shift(),this.metricsPack.txBytes.push(this.manager.txBytes),this.metricsPack.txBytes.length>10&&this.metricsPack.txBytes.shift(),this.metricsPack.rxBytes.push(this.manager.rxBytes),this.metricsPack.rxBytes.length>10&&this.metricsPack.rxBytes.shift(),this.metricsPack.unixTime=Math.floor(Date.now()/1e3),this.metricsPack.period=1e4,this.manager.txBytes=0,this.manager.rxBytes=0}),1e4)}oneline(e){let t=[{...p.memoryUsage()}];e&&console.table(t,["rss","heapTotal","heapUsed","external","arrayBuffers"]);let s=[{lastSSID:this.manager.lastSSID,remotes:this.manager.remotes.size,channels:this.manager.channel_map.size,txBytes:this.manager.txBytes,rxBytes:this.manager.rxBytes}];return e&&console.table(s,["lastSSID","remotes","channels","txBytes","rxBytes"]),s[0]}getRemotes(e){let t=Array.from(this.manager.remotes.values()).map((e=>"#"+e.ssid+":"+e.cid+"("+e.state+")"));return e&&console.table(t),t}getCIdList(e){let t=Array.from(this.manager.cid2remote.keys());return e&&console.table(t),t}getChannelList(e){let t=Array.from(this.manager.channel_map.keys());return e&&console.table(t),t}getSubscribers(e){let t=[];if(this.manager.channel_map.has(e)){this.manager.channel_map.get(e).forEach((e=>{t.push(e.cid)}))}return t}getRemoteByCId(e,t=1){if(!this.manager.cid2remote.has(e))return{result:"nop"};{let s=this.manager.cid2remote.get(e);if(1==t)return{ip:s.ip,id:s.cid,ssid:s.ssid,cid:s.cid,uptime:Math.trunc((Date.now()-s.socket.openTime)/1e3),tx:s.socket.txCounter,rx:s.socket.rxCounter,txBytes:s.socket.bytesWritten||s.socket._socket?.bytesWritten,rxBytes:s.socket.bytesRead||s.socket._socket?.bytesRead};if(2==t)return{ip:s.ip,uptime:Math.trunc((Date.now()-s.socket.openTime)/1e3),nick:s.nick,ssid:s.ssid,echo:s.lastEchoMessage};if(3==t)return{ip:s.ip,uptime:Math.trunc((Date.now()-s.socket.openTime)/1e3),nick:s.nick,ssid:s.ssid,isSecure:s.TLS,isAuth:s.boho.isAuthorized,encMode:fe[s.encMode]};if(4==t){let e=Array.from(s.channels.keys()),t=Array.from(s.memory.keys()),r=Array.from(s.retain_signal.keys());return{ip:s.ip,uptime:Math.trunc((Date.now()-s.socket.openTime)/1e3),channels:e,set:t,retain:r}}}}}const Fr=new TextEncoder,$r=new TextDecoder;class Wr{constructor(e,t){this.server=e,this.txBytes=0,this.rxBytes=0,this.authManager=t,this.connectionLogger,Nr.fileLogger.connection.use&&(this.connectionLogger=new Dr(Nr.fileLogger.connection.path)),this.attackLogger,Nr.fileLogger.attack.use&&(this.attackLogger=new Dr(Nr.fileLogger.attack.path)),this.remotes=new Set,this.cid2remote=new Map,this.retain_messages=new Map,this.channel_map=new Map,this.CHANNEL_PREFIX="CH:",this.CID_PREFIX="CID:",this.metric=new Hr(this),this.lastSSID=0,this.pingIntervalID=setInterval((e=>{this.remotes.forEach((function(e){let t=e.socket;!1===t.isAlive&&(console.log("## timeout. cid:",e.cid),e.close()),t.txCounter++,t.isAlive=!1,"websocket"===e.socketType?t.ping():e.ping()}))}),Nr.timeout),Nr.showMetric&&(this.monitIntervalID=setInterval((e=>{this.monitor()}),Nr.monitorPeriod))}addRemote(e,t){e.isAlive=!0;let s=new Ur(e,t,this);this.remotes.add(s),s.send(Buffer.from([pe.SERVER_READY])),s.setState(le.SENT_SERVER_READY),this.lastSSID=s.ssid;let r=`+ IP:${s.ip} #${s.ssid} ${"websocket"===e.socketType?"WS":"CS"} `;this.connectionLogger&&this.connectionLogger.log(r)}removeRemote(e){let t=`- IP:${e.ip} #${e.ssid} cid:${e.cid} ${"websocket"===e?.socket.socketType?"WS":"CS"} `;this.connectionLogger&&this.connectionLogger.log(t),this.deligateSignal(e,"@state","close"),this.deligateSignal(e,"@$state","close");for(let t of e.channels.keys())if(this.channel_map.has(t)){const s=this.channel_map.get(t);s.delete(e),0==s.size&&this.channel_map.delete(t)}if(e.boho.isAuthorized);else for(let t of e.retain_signal.keys())t=this.CID_PREFIX+e.cid+"@"+t,this.channel_map.has(t)&&this.channel_map.delete(t);if(e.uid&&this.server.apiNames.has("account")){let t={topic:"detachUserRemote",args:["caller:manager.removeRemote"]};this.server.emit("account",e,t)}this.remotes.delete(e),this.cid2remote.delete(e.cid),e=null}serverSignal(e){let t=x(b("#MsgType","8",pe.SERVER_SIGNAL),b("#signalObject",e));this.remotes.forEach((e=>{e.send_enc_mode(t)}))}getSignalTag(e){let t=e.readUint8(1),s=e.subarray(2,2+t);return $r.decode(s)}getNewSignalTagMessage(e,t){let s=e[0],r=e.readUint8(1),i=Fr.encode(t),n=i.byteLength,o=e.subarray(2+r);return Buffer.concat([Buffer.from([s,n]),i,o])}deligateSignal(e,t,...s){let r=me(t,...s);this.sender(t,e,r)}adminSignal(e,t){return this.cid2remote.has(e)?void this.cid2remote.get(e).send_enc_mode(t):"no cid"}serverSignalTo(e,...t){let s=e.split("@")[0],r=me("@"+e.split("@")[1],...t);if(s&&this.cid2remote.has(s)){let e=this.cid2remote.get(s);return console.log("target",e.state,e.cid),void e.send_enc_mode(r)}return"no cid"}sender(e,t,s){if(Nr.memberOnly&&!t.boho.isAuthorized)return t.send(Buffer.from([pe.SERVER_CLEAR_AUTH])),t.close(),["err","not autrized"];if(0==e.indexOf("$"))return["err","prefix $ is reserved for userSet tag."];let r=e.indexOf("@");if(0===r)e=t.cid+e,s=this.getNewSignalTagMessage(s,e);else if(r>0){let t=e.split("@")[0];if(this.cid2remote.has(t)){let r="@"+e.split("@")[1];return s=this.getNewSignalTagMessage(s,r),this.cid2remote.get(t).send_enc_mode(s),["ok",1]}return["err","Invalid cid"]}if((e=0===e.indexOf("#")?t.HOME_CHANNEL+e:e.includes("@")?this.CID_PREFIX+e:this.CHANNEL_PREFIX+e).includes("$")&&Nr.retain.isAvailable&&Nr.retain.limitCounter>this.retain_messages.size&&Nr.retain.limitSize>s.byteLength)if(e.includes("@")){let r=e.split("@")[1];t.retain_signal.set(r,s)}else this.retain_messages.set(e,s);let i=0;if(this.channel_map.has(e)){let r=this.channel_map.get(e);if(r.size>=1){let e;e=Nr.useQuota.publishCounter?Math.min(t.quota.publishCounter,r.size):r.size;let n=r.values();for(;i<e;){let e=n.next().value;if(!e)break;e!==t&&(e.send_enc_mode(s),i++)}return Nr.useQuota.publishCounter,["ok",i]}}return["err","No subscriber."]}subscribe(e,t){return e.forEach((e=>{if(e=0===e.indexOf("#")?t.HOME_CHANNEL+e:e.includes("@")?this.CID_PREFIX+e:this.CHANNEL_PREFIX+e,this.channel_map.has(e)?this.channel_map.get(e).add(t):this.channel_map.set(e,new Set([t])),t.channels.add(e),e.includes("$")&&Nr.retain.isAvailable){let s;if(e.includes("@")){let t=e.split("@")[0];t=t.split(this.CID_PREFIX)[1];let r=e.split("@")[1];if(!this.cid2remote.has(t))return;s=this.cid2remote.get(t).retain_signal.get(r)}else this.retain_messages.has(e)&&(s=this.retain_messages.get(e));s&&t.send_enc_mode(s)}})),t.channels.size}unsubscribe(e,t){1==e.length&&""==e[0]?(t.channels.forEach((e=>{if(this.channel_map.has(e)){let s=this.channel_map.get(e);s.delete(t),0==s.size&&this.channel_map.delete(e)}})),t.channels.clear()):e.forEach((e=>{if(e=0===e.indexOf("#")?t.HOME_CHANNEL+e:e.includes("@")?this.CID_PREFIX+e:this.CHANNEL_PREFIX+e,this.channel_map.has(e)){let s=this.channel_map.get(e);s.delete(t),0==s.size&&this.channel_map.delete(e)}t.channels.delete(e)}))}monitor(){switch(process.stdout.isTTY&&(process.stdout.cursorTo(0,0),process.stdout.clearScreenDown()),Nr.showChannel>0&&this.metric.channels(Nr.showChannel),parseInt(Nr.showMetric)){case 1:this.metric.oneline(!0);break;case 2:this.metric.getRemotes(!0);break;case 3:this.metric.getChannelList(!0)}}closeRemoteByCId(e){return this.cid2remote.has(e)?(this.cid2remote.get(e).close(),1):0}}const zr=0,jr=255;const Gr=new TextDecoder;class Vr{constructor(){this.authLogger,Nr.fileLogger.auth.use&&(this.authLogger=new Dr(Nr.fileLogger.auth.path),console.log("Auth: begin file logger.[auth]"))}send_auth_fail(e,t){if(this.authLogger){let s=`FAIL #${e.ssid} reason:${t} `;this.authLogger.log(s)}console.log("## AUTH_FAIL reason:",t),e.setState(le.AUTH_FAIL),setTimeout((t=>{e.send(Buffer.from([se.AUTH_FAIL]))}),Nr.auth.delay_auth_fail)}async verify_auth_hmac(e,t){try{let s=T(e,re.AUTH_HMAC);if(!s)return void this.send_auth_fail(t,"unpack auth_pack fail");let r="";r=s.id8.includes(0)?Gr.decode(s.id8.subarray(0,s.id8.indexOf(0))):Gr.decode(s.id8);let i,n=await this.getAuth(r);if(Nr.debug.showAuthInfo,!n)return void this.send_auth_fail(t,"NO ID:"+r);t.boho.copy_id8(s.id8);const o=44;n.key.length==o?(i=Buffer.from(n.key,"base64"),t.boho.copy_key(i)):t.boho.set_key(n.key);let a=t.boho.check_auth_hmac(s);if(!a)return void this.send_auth_fail(t,"hmac dismatched");if(t.manager.cid2remote.has(n.cid)){let e=t.manager.cid2remote.get(n.cid);return e==t?void console.log("## trying RELOGIN with SAME ID. ignored."):(console.log("### clear_auth and close old connection:",e.cid),e.send(Buffer.from([pe.SERVER_CLEAR_AUTH])),e.close(),void t.close())}t.cid&&t.manager.cid2remote.delete(t.cid),t.did=r,t.cid=n.cid,t.nick=n.cid;let h=Nr.defaultQuotaIndex;n.level&&(h=n.level),h=parseInt(h);let c=_e[h];if(!c){let e="no index quotaTable for auth.level: "+h;return console.log("##AUTH:DATA ERROR##",e),void this.send_auth_fail(t,e)}if(t.level=h,t.quota=c,t.level===Nr.adminLevel&&(console.log("## LOGIN ADMIN CID:",t.cid),t.isAdmin=!0),t.send(Buffer.from([pe.QUOTA_LEVEL,h])),t.manager.cid2remote.set(t.cid,t),t.send(a),t.setState(le.AUTH_READY),this.authLogger){let e=`OK #${t.ssid} cid: ${t.cid} did:${t.did}`;t.isAdmin&&(e="#ADMIN# "+e),this.authLogger.log(e)}return n}catch(e){this.send_auth_fail(t,"caught: unknown error"+e)}}}const qr="device:";var Yr=Object.freeze({__proto__:null,checkPermission:function(e){return e.level>=0},date:async function(e,t){let s=(new Date).toUTCString();e.response(t.mid,zr,s)},echo:async function(e,t){t.args?e.response(t.mid,zr,t.args):e.response(t.mid,jr,"no message to echo")},unixtime:async function(e,t){let s=Math.floor(Date.now()/1e3);e.response(t.mid,zr,s)}});var Qr=Object.freeze({__proto__:null,checkPermission:function(e){return e.level>=255},commands:["cid","remotes","clients","channels","subscribers","remote","client","close","addauth","getauth","delauth","getauthidlist","getdevicelist","adddevice","getdevice","deldevice"],request:async function(e,t){let s,r=0;try{let i=t.topic;if(i=i.toLowerCase(),"cid"==i)s=e.manager.metric.getCIdList();else if("remotes"==i||"clients"==i)s=e.manager.metric.getRemotes();else if("channels"==i)s=e.manager.metric.getChannelList();else if("subscribers"==i){let r=t.$[0];r&&(s=e.manager.metric.getSubscribers(r))}else if("remote"==i||"client"==i){let r=t.$[0],i=t.$[1];r&&(s=e.manager.metric.getRemoteByCId(r,i))}else if("close"==i)t.$[0]&&(s=e.manager.closeRemoteByCId(t.$[0]));else if("addauth"==i||"adddevice"==i){if(e.manager.authManager&&4==t.$.length&&e.manager.authManager.addAuth){let r=t.$[0],i=t.$[1],n=t.$[2],o=t.$[3];s=await e.manager.authManager.addAuth(r,i,n,o)}}else if("delauth"==i||"deldevice"==i){if(e.manager.authManager&&1==t.$.length&&e.manager.authManager.delAuth){let r=t.$[0];s=await e.manager.authManager.delAuth(r)}}else if("getauth"==i||"getdevice"==i){if(e.manager.authManager&&1==t.$.length&&e.manager.authManager.getAuth){let r=t.$[0];s=await e.manager.authManager.getAuth(r)}}else"getauthidlist"==i||"getdevicelist"==i?e.manager.authManager&&e.manager.authManager.getAuthIdList&&(s=await e.manager.authManager.getAuthIdList()):(r=jr,s="api sudo: no such a cmd: "+i);e.response(t.mid,r,s)}catch(s){e.response(t.mid,jr,s.message)}}});const Kr=["GET","SET","HGETALL","HGET","HSET","SADD","SISMEMBER","SMEMBERS","EXISTS","SREM","DEL","KEYS","SAVE"];Object.defineProperty(exports,"Buffer",{enumerable:!0,get:function(){return e.Buffer}}),exports.API_TYPE={REQUEST_RESPONSE:"requet_response",ONE_WAY:"one_way"},exports.Auth_Env=class extends Vr{constructor(e){let t;super(),e?t=e.split(","):process.env.BOHO_AUTH?(e=process.env.BOHO_AUTH,t=process.env.BOHO_AUTH.split(",")):(console.log("Auth_Env: None of process.env.BOHO_AUTH or authInfo"),process.exit()),this.AUTH=new Map,t.length>=1?t.forEach((e=>{let t=e.split(".")[0],s=e.split(".")[1],r=e.split(".")[2];if(r=parseInt(r),t&&s&&"number"==typeof r){let e=t;this.addAuth(t,s,e,r)}else console.log("Wrong process.env.BOHO_AUTH authentication value.",id,s,r),process.exit()})):(console.log("Wrong process.env.BOHO_AUTH authentication value."),process.exit())}async getAuth(e){return this.AUTH.get(e)}async getAuthIdList(){return Array.from(this.AUTH.keys())}addAuth(e,t,s,r=0){let i=Buffer.from(ee.hash(t)).toString("base64");this.AUTH.set(e,{key:i,cid:s,level:r})}},exports.Auth_File=class extends Vr{constructor(e){super(),this.AUTH=new Map;let t=o.parse(e);this.path=o.resolve(e),console.log("auth from file path:",this.path);let s=t.ext;".js"==s.toLowerCase()||".mjs"==s.toLowerCase()?(console.log("#JS path:",this.path),this.loadAuthInfoFile_JS(this.path)):".json"==s.toLowerCase()?(console.log("#JSON path:",this.path),this.loadAuthInfoFile_JSON(this.path)):console.log("no authinfofile path.")}async getAuth(e){return this.AUTH.get(e)}async getAuthIdList(){return Array.from(this.AUTH.keys())}loadAuthInfoFile_JS(e){import(e).then((e=>{console.log(e.authInfo),e.authInfo.forEach((e=>{this.addAuth(...e)})),console.log("total AUTH INFO size: ",this.AUTH.size)})).catch((e=>{console.log(e)}))}loadAuthInfoFile_JSON(e){let t=n.readFileSync(e);t=(new TextDecoder).decode(t),JSON.parse(t).forEach((e=>{this.addAuth(...e)})),console.log("total AUTH INFO size: ",this.AUTH.size)}addAuth(e,t,s,r=0){let i=Buffer.from(ee.hash(t)).toString("base64");this.AUTH.set(e,{key:i,cid:s,level:r})}},exports.Auth_Redis=class extends Vr{constructor(e){if(super(),!e)throw new Error("AuthRedis constructor: no redisClient");this.redis=e}async getAuth(e){let t=await this.redis.hGetAll(qr+e);if(t.key)return t}async getAuthIdList(){let e=await this.redis.keys(qr+"*");if(e=e.map((e=>e.split(":")[1])),e)return e}async addAuth(e,t,s="",r=0){let i=Buffer.from(ee.hash(t)).toString("base64");return this.redis.hSet(qr+e,{key:i,cid:s,level:r})}async delAuth(e){return this.redis.del(qr+e)}async save(e){return this.redis.save()}},exports.Boho=he,exports.BohoAuth=Vr,exports.BohoMsg=se,exports.CLIENT_STATE=le,exports.CongRx=Te,exports.ENC_MODE=fe,exports.FileLogger=Dr,exports.IO=class extends Ee{constructor(e){super(e),e&&this.open()}close(){this.socket&&(this.socket.onclose=null,this.socket.onmessage=null,this.socket.onerror=null,this.socket.close(),this.socket=null),this.emit("close")}stop(){this.close(),clearInterval(this.connectionCheckerIntervalID),this.connectionCheckerIntervalID=null}keepAlive(){this.socket&&3!==this.socket?.readyState||this.open()}createConnection(e){this.socket=new dr(e),this.stateChange("opening"),this.socket.onopen=()=>{this.socket.on("message",this.onWebSocketMessage.bind(this)),this.emit("open")},this.socket.onerror=e=>{this.emit("error",e)},this.socket.onclose=()=>{this.emit("close")}}onWebSocketMessage(e){this.rxCounter++,this.lastTxRxTime=Date.now(),this.rxBytes+=e.byteLength,this.emit("socket_data",e)}socket_send(e){1===this.socket?.readyState?(this.socket.send(e),this.txCounter++,this.txBytes+=e.byteLength,this.lastTxRxTime=Date.now()):console.log(".")}},exports.IOCongSocket=class extends Ee{constructor(e){super(e),e&&this.open()}close(){this.socket?.end(),this.socket=null}stop(){this.close(),clearInterval(this.connectionCheckerIntervalID),this.connectionCheckerIntervalID=null}keepAlive(){let e=this.socket?.readyState;(!this.socket||"open"!==e&&"opening"!==e)&&this.open()}createConnection(e){let t=new URL(e);"cong:"!=t.protocol&&(t=new URL("cong://"+e)),this.socket=r.createConnection(t.port,t.hostname),this.stateChange("opening"),this.socket.on("connect",(()=>{this.congRx=new Te,this.socket.pipe(this.congRx),this.congRx.on("data",this.onTCPSocketMessage.bind(this)),this.emit("open")})),this.socket.on("error",(e=>{this.emit("error",e)})),this.socket.on("close",(()=>{this.emit("close")}))}onTCPSocketMessage(e){this.rxCounter++,this.rxBytes+=e.byteLength,this.lastTxRxTime=Date.now(),this.emit("socket_data",e)}socket_send(e){if("open"===this.socket?.readyState){let t=xe(e);this.socket.write(t),this.txCounter++,this.txBytes+=t.byteLength,this.lastTxRxTime=Date.now()}else console.log(".")}},exports.IOMsg=pe,exports.MBP=G,exports.Meta=re,exports.MetaSize=ne,exports.PAYLOAD_TYPE=de,exports.RAND=ae,exports.RedisAPI=class{constructor(e,t){if(!e)throw new Error("RedisAPI constructor: no redisClient");this.redisClient=e,this.minLevel=t||200,this.commands=Kr}checkPermission(e,t){return console.log("checkPermission",e.level,"vs",this.minLevel),e.level>=this.minLevel}async request(e,t){let s,r=zr;try{let i=t.topic;i=i.toUpperCase(),Kr.includes(i)?(console.log("RedisAPI call:",i,t.args),s=t.args.length>0?await this.redisClient[i](...t.args):await this.redisClient[i]()):r=jr,e.response(t.mid,r,s)}catch(s){e.response(t.mid,jr,s.message)}}},exports.SIZE_LIMIT=ue,exports.STATES=ce,exports.STATUS={OK:0,ERROR:255},exports.Server=class extends c{constructor(e,t){if(super(),this.apiNames=new Set,this.wss={},e.timeout){let t=parseInt(e.timeout);t&&t>=1e3&&(Nr.timeout=t)}if(e.monitorPeriod){let t=parseInt(e.monitorPeriod);t&&t>=1e3&&(Nr.monitorPeriod=t)}e.showMessage&&(Nr.showMessage=e.showMessage),e.showMetric&&(Nr.showMetric=e.showMetric),e.timeout&&(Nr.timeout=e.timeout),e.port&&(Nr.port=parseInt(e.port)),e.httpServer&&(Nr.httpServer=e.httpServer),e.congPort&&(Nr.congPort=parseInt(e.congPort)),this.manager=new Wr(this,t),(Nr.port||Nr.httpServer)&&this.startWSServer(Nr),Nr.congPort&&this.startCongServer(Nr.congPort)}startWSServer(e){if(e.port)console.log("opening WebSocket Server port:",e.port),this.wss=new Or({port:e.port});else{if(!e.httpServer)throw new TypeError('One and only one of the "port", "httpServer"must be specified');console.log("opening WebSocket Server external httpServer:"),this.wss=new Or({server:e.httpServer})}this.wss.on("error",(e=>{console.error("### ws server error:",e.message),"EADDRINUSE"==e.code&&process.exit()})),this.wss.on("close",(e=>{console.log("### WS server closed.",e)})),this.wss.on("connection",((e,t)=>{e.socketType="websocket",this.manager.addRemote(e,t)}))}startCongServer(e){console.log("opening CongSocket Server:",e),this.congServer=r.createServer((e=>{this.manager.addRemote(e)})).on("error",(e=>{console.log("### cong server error:",e.message),"EADDRINUSE"==e.code&&process.exit()})).listen(e,(()=>{}))}api(e,t){if(this.apiNames.add(e),!t.checkPermission||"function"!=typeof t.checkPermission)throw new Error("wrong api interface. no checkPermission function.");if("function"==typeof t.request&&Array.isArray(t.commands))console.log(`API TYPE1. A Class with one request function. target: ${e} list: ${t.commands}`),this.on(e,((e,s)=>{t.checkPermission(e,s)?t.request(e,s):e.response(s.mid,jr,"NO_PERMISSION.")}));else{let s=[];Object.keys(t).forEach((e=>{"function"==typeof t[e]&&s.push(e),console.log("api list",typeof t[e],e)})),console.log(`API TYPE2. Multiple function list.  target: ${e} list:${s}`),this.on(e,((s,r)=>{let i;if(t.checkPermission(s,r)){if(t[r.topic])return console.log(`API TYPE2. request target: ${e}  has topic:${r.topic}`),void t[r.topic](s,r);i=`target: ${r.target} has not topic name: ${r.topic}`}else i="NO_PERMISSION.";s.response(r.mid,jr,i)}))}return this}},exports.api_reply=Yr,exports.api_sudo=Qr,exports.pack=xe,exports.serverOption=Nr,exports.sha256=ee;
